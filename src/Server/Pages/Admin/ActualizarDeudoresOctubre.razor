@page "/admin/actualizar-deudores-octubre"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using Server.Data
@using Server.Models
@inject AppDbContext DbContext
@inject NavigationManager Nav
@attribute [Authorize(Policy = "AdminTesorero")]

<h1 class="hidden">Actualizar Deudores - Octubre 2025</h1>

<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">
                üìä Actualizar Estado de Deudores - Octubre 2025
            </h1>

            @if (!ejecutado)
            {
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700 dark:text-yellow-200">
                                <strong>ADVERTENCIA:</strong> Este script actualizar√° los registros de deudores en la base de datos.
                                Aseg√∫rate de tener un backup antes de continuar.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-6 space-y-4">
                    <h2 class="text-xl font-semibold text-slate-900 dark:text-white">Resumen de Actualizaciones:</h2>
                    
                    <div class="bg-slate-50 dark:bg-slate-700 rounded p-4 space-y-3">
                        <div>
                            <h3 class="font-medium text-slate-900 dark:text-white mb-2">1Ô∏è‚É£ Nuevos Miembros (Octubre 2025)</h3>
                            <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 space-y-1">
                                <li>LAURA VIVIAN ASALAZAR MORENO</li>
                                <li>JOSE JULIAN VILLAMIZAR ARAQUE</li>
                                <li>GUSTAVO ADOLFO G√ìMEZ ZULUAGA</li>
                                <li>Nelson Augusto Montoya Mataute</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="font-medium text-slate-900 dark:text-white mb-2">2Ô∏è‚É£ Miembros al D√≠a</h3>
                            <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 space-y-1">
                                <li>RAM√ìN ANTONIO GONZALEZ CASTA√ëO ‚Üí Hasta octubre 2025</li>
                                <li>CARLOS ALBERTO ARAQUE BETANCUR ‚Üí Hasta diciembre 2025</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="font-medium text-slate-900 dark:text-white mb-2">3Ô∏è‚É£ Deuda Moderada (1-5 meses)</h3>
                            <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 space-y-1">
                                <li>MILTON DARIO GOMEZ RIVERA ‚Üí Debe 4 meses (jul-oct)</li>
                                <li>DANIEL ANDREY VILLAMIZAR ARAQUE ‚Üí Debe 4 meses (jul-oct)</li>
                                <li>ANGELA MARIA RODRIGUEZ ‚Üí Debe 1 mes (octubre)</li>
                                <li>CESAR LEONEL RODRIGUEZ GALAN ‚Üí Debe 1 mes (octubre)</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="font-medium text-slate-900 dark:text-white mb-2">4Ô∏è‚É£ Deuda Alta (6+ meses)</h3>
                            <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 space-y-1">
                                <li>GIRLESA MAR√çA BUITRAGO ‚Üí Debe 9 meses (feb-oct)</li>
                            </ul>
                        </div>

                        <div>
                            <h3 class="font-medium text-slate-900 dark:text-white mb-2">5Ô∏è‚É£ Deuda Total del A√±o (10 meses)</h3>
                            <ul class="list-disc list-inside text-sm text-slate-700 dark:text-slate-300 space-y-1">
                                <li>HECTOR MARIO GONZALEZ HENAO</li>
                                <li>JHON JARVEY G√ìMEZ PATI√ëO</li>
                                <li>CARLOS MARIO CEBALLOS</li>
                                <li>CARLOS ANDRES PEREZ AREIZA</li>
                                <li>JUAN ESTEBAN SUAREZ CORREA</li>
                                <li>JOS√â EDINSON OSPINA CRUZ</li>
                                <li>JEFFERSON MONTOYA MU√ëOZ</li>
                                <li>ROBINSON ALEHANDRO GALVIS PARRA</li>
                                <li>JHON ENMANUEL ARZUZA P√ÅEZ</li>
                                <li>JUAN ESTEBAN OSORIO</li>
                                <li>YEFERSON BAIR√ìN USUGA AGUDELO</li>
                                <li>JHON DAVID SANCHEZ</li>
                                <li>CARLOS JULIO REND√ìN D√çAZ</li>
                                <li>JENNIFER ANDREA CARDONA BENITEZ</li>
                                <li>WILLIAM HUMBERTO JIMENEZ PEREZ</li>
                                <li>CARLOS MARIO DIAZ DIAZ</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button @onclick="EjecutarActualizacion" 
                            disabled="@procesando"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-400 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                        @if (procesando)
                        {
                            <span>‚è≥ Procesando...</span>
                        }
                        else
                        {
                            <span>Ejecutar Actualizaci√≥n</span>
                        }
                    </button>
                    
                    <button @onclick='() => Nav.NavigateTo("/tesoreria/deudores")' 
                            class="px-6 py-3 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                        Cancelar
                    </button>
                </div>
            }
            else
            {
                <div class="space-y-4">
                    <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-green-700 dark:text-green-200">
                                    <strong>Actualizaci√≥n completada exitosamente</strong>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-700 rounded p-4">
                        <h3 class="font-semibold text-slate-900 dark:text-white mb-2">üìù Log de Ejecuci√≥n:</h3>
                        <pre class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap font-mono">@log</pre>
                    </div>

                    <div class="flex gap-4">
                        <button @onclick='() => Nav.NavigateTo("/tesoreria/deudores")' 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            Ver Listado de Deudores
                        </button>
                        
                        <button @onclick="() => ejecutado = false" 
                                class="px-6 py-3 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            Volver
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool procesando = false;
    private bool ejecutado = false;
    private string log = "";

    private async Task EjecutarActualizacion()
    {
        procesando = true;
        log = "";
        StateHasChanged();

        try
        {
            log += "=== Iniciando actualizaci√≥n de deudores - Octubre 2025 ===\n\n";
            
            var mensualidad = await DbContext.Conceptos.FirstOrDefaultAsync(c => c.Codigo == "MENSUALIDAD");
            if (mensualidad == null)
            {
                log += "Error: Concepto MENSUALIDAD no encontrado\n";
                return;
            }

            var fechaActual = new DateOnly(2025, 10, 27);
            
            // 1. Actualizar fecha de ingreso nuevos miembros
            log += "1Ô∏è‚É£ Actualizando fecha de ingreso nuevos miembros...\n";
            var nuevosMiembros = new[]
            {
                "LAURA VIVIAN ASALAZAR MORENO",
                "JOSE JULIAN VILLAMIZAR ARAQUE",
                "GUSTAVO ADOLFO G√ìMEZ ZULUAGA",
                "Nelson Augusto Montoya Mataute"
            };

            foreach (var nombreCompleto in nuevosMiembros)
            {
                var miembro = await DbContext.Miembros.FirstOrDefaultAsync(m => 
                    m.NombreCompleto.ToUpper() == nombreCompleto.ToUpper());
                
                if (miembro != null)
                {
                    miembro.FechaIngreso = new DateOnly(2025, 10, 1);
                    miembro.UpdatedAt = DateTime.UtcNow;
                    miembro.UpdatedBy = "admin_actualizacion_octubre_2025";
                    log += $"  {nombreCompleto}\n";
                }
                else
                {
                    log += $"  ADVERTENCIA: {nombreCompleto}: NO ENCONTRADO\n";
                }
            }

            // 2. Crear recibos
            log += "\n2Ô∏è‚É£ Creando recibos de pago...\n";
            
            await CrearReciboMensualidad(mensualidad, "RAM√ìN ANTONIO GONZALEZ CASTA√ëO", 2025, 10, 10);
            await CrearReciboMensualidad(mensualidad, "CARLOS ALBERTO ARAQUE BETANCUR", 2025, 12, 12);
            await CrearReciboMensualidad(mensualidad, "MILTON DARIO GOMEZ RIVERA", 2025, 6, 6);
            await CrearReciboMensualidad(mensualidad, "DANIEL ANDREY VILLAMIZAR ARAQUE", 2025, 6, 6);
            await CrearReciboMensualidad(mensualidad, "ANGELA MARIA RODRIGUEZ", 2025, 9, 9);
            await CrearReciboMensualidad(mensualidad, "CESAR LEONEL RODRIGUEZ GALAN", 2025, 9, 9);
            await CrearReciboMensualidad(mensualidad, "GIRLESA MAR√çA BUITRAGO", 2025, 1, 1);

            // 3. Guardar cambios
            log += "\nüíæ Guardando cambios...\n";
            await DbContext.SaveChangesAsync();
            
            log += "\nActualizaci√≥n completada exitosamente\n";
            ejecutado = true;
        }
        catch (Exception ex)
        {
            log += $"\nError: {ex.Message}\n{ex.StackTrace}\n";
        }
        finally
        {
            procesando = false;
            StateHasChanged();
        }
    }

    private async Task CrearReciboMensualidad(Concepto mensualidad, string nombreCompleto, int ano, int mes, int cantidadMeses)
    {
        var miembro = await DbContext.Miembros.FirstOrDefaultAsync(m => 
            m.NombreCompleto.ToUpper() == nombreCompleto.ToUpper());
        
        if (miembro == null)
        {
            log += $"  ADVERTENCIA: {nombreCompleto}: NO ENCONTRADO\n";
            return;
        }

        var fechaEmision = new DateTime(ano, mes, 1);

        // Verificar si ya existe
        var reciboExistente = await DbContext.Recibos
            .Include(r => r.Items)
            .Where(r => r.MiembroId == miembro.Id 
                     && r.FechaEmision.Month == fechaEmision.Month 
                     && r.FechaEmision.Year == fechaEmision.Year
                     && r.Items.Any(i => i.ConceptoId == mensualidad.Id))
            .FirstOrDefaultAsync();

        if (reciboExistente != null)
        {
            log += $"  INFO: {nombreCompleto}: Ya registrado\n";
            return;
        }

        var recibo = new Recibo
        {
            Id = Guid.NewGuid(),
            MiembroId = miembro.Id,
            FechaEmision = fechaEmision,
            Estado = EstadoRecibo.Emitido,
            Observaciones = $"Pago retroactivo - {cantidadMeses} mes(es)",
            CreatedAt = DateTime.UtcNow,
            CreatedBy = "admin_actualizacion_octubre_2025",
            TotalCop = mensualidad.PrecioBase * cantidadMeses,
            Items = new List<ReciboItem>
            {
                new ReciboItem
                {
                    ConceptoId = mensualidad.Id,
                    Cantidad = cantidadMeses,
                    PrecioUnitarioMonedaOrigen = mensualidad.PrecioBase,
                    MonedaOrigen = mensualidad.Moneda,
                    SubtotalCop = mensualidad.PrecioBase * cantidadMeses,
                    Notas = $"{cantidadMeses} mensualidad(es)"
                }
            }
        };

        DbContext.Recibos.Add(recibo);
        log += $"  {nombreCompleto}: {cantidadMeses} meses\n";
    }
}
