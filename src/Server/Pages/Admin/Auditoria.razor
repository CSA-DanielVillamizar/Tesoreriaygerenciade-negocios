@page "/admin/auditoria"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "AdminOrTesoreroWith2FA")]
@inject Server.Services.Audit.IAuditService AuditService
@inject Server.Services.Export.ICsvExportService CsvExportService
@inject Microsoft.JSInterop.IJSRuntime JS
@inject ToastService Toast
@using Server.Models
@using System.Text.Json

<PageTitle>Auditoría del Sistema - LAMA Medellín</PageTitle>

<Breadcrumb Items="@breadcrumbs" />

<UICard Class="mb-6">
    <Header>
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span class="text-2xl font-semibold">Registro de Auditoría</span>
        </div>
        <div class="flex gap-2">
            <!-- Toggle Vista -->
            <div class="inline-flex rounded-lg border border-slate-300 dark:border-slate-700 p-1 bg-slate-50 dark:bg-slate-800">
                <button 
                    @onclick="@(() => vistaTimeline = false)"
                    class="px-3 py-1.5 text-sm font-medium rounded-md transition @(!vistaTimeline ? "bg-white dark:bg-slate-900 text-blue-600 shadow-sm" : "text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200")"
                    title="Vista de tabla">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
                <button 
                    @onclick="@(() => vistaTimeline = true)"
                    class="px-3 py-1.5 text-sm font-medium rounded-md transition @(vistaTimeline ? "bg-white dark:bg-slate-900 text-blue-600 shadow-sm" : "text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200")"
                    title="Vista de timeline">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
            
            <UIButton Variant="ghost" Size="sm" OnClick="@ExportarCsv">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Exportar CSV
            </UIButton>
        </div>
    </Header>
    <ChildContent>
                <!-- Filtros con glassmorphism -->
                <div class="glass-card p-6 rounded-2xl mb-6 backdrop-blur-lg bg-white/80 dark:bg-slate-900/80 border border-slate-200/50 dark:border-slate-700/50 shadow-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Tipo de Entidad</label>
                            <MudSelect T="string" 
                                       Value="@filtroEntityType" 
                                       ValueChanged="@OnEntityTypeChanged"
                                       Variant="Variant.Outlined" 
                                       Margin="Margin.Dense"
                                       Class="rounded-xl"
                                       AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@("")">Todas</MudSelectItem>
                                <MudSelectItem Value="@("CertificadoDonacion")">Certificados</MudSelectItem>
                                <MudSelectItem Value="@("Recibo")">Recibos</MudSelectItem>
                                <MudSelectItem Value="@("Miembro")">Miembros</MudSelectItem>
                                <MudSelectItem Value="@("Egreso")">Egresos</MudSelectItem>
                                <MudSelectItem Value="@("CierreMensual")">Cierres</MudSelectItem>
                            </MudSelect>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Acción</label>
                            <MudSelect T="string" 
                                       Value="@filtroAction" 
                                       ValueChanged="@OnActionChanged"
                                       Variant="Variant.Outlined" 
                                       Margin="Margin.Dense"
                                       Class="rounded-xl"
                                       AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@("")">Todas</MudSelectItem>
                                <MudSelectItem Value="@("Emitted")">Emitido</MudSelectItem>
                                <MudSelectItem Value="@("Annulled")">Anulado</MudSelectItem>
                                <MudSelectItem Value="@("Created")">Creado</MudSelectItem>
                                <MudSelectItem Value="@("Updated")">Actualizado</MudSelectItem>
                                <MudSelectItem Value="@("Deleted")">Eliminado</MudSelectItem>
                            </MudSelect>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Usuario</label>
                            <MudTextField T="string" 
                                          Value="@filtroUserName" 
                                          ValueChanged="@OnUserNameChanged"
                                          Variant="Variant.Outlined" 
                                          Margin="Margin.Dense"
                                          Placeholder="usuario@fundacionlamamedellin.org"
                                          Class="rounded-xl"
                                          Immediate="false" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Fecha Desde</label>
                            <MudDatePicker @bind-Date="@filtroFechaDesde"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Class="rounded-xl"
                                           DateFormat="dd/MM/yyyy"
                                           Editable="true"
                                           Placeholder="Seleccionar fecha"
                                           AutoClose="true" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Fecha Hasta</label>
                            <MudDatePicker @bind-Date="@filtroFechaHasta"
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Class="rounded-xl"
                                           DateFormat="dd/MM/yyyy"
                                           Editable="true"
                                           Placeholder="Seleccionar fecha"
                                           AutoClose="true" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">ID de Entidad</label>
                            <MudTextField T="string" 
                                          @bind-Value="@filtroEntityId"
                                          Variant="Variant.Outlined" 
                                          Margin="Margin.Dense"
                                          Placeholder="GUID de la entidad"
                                          Class="rounded-xl" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Registros</label>
                            <MudSelect T="int" 
                                       @bind-Value="@cantidadRegistros"
                                       Variant="Variant.Outlined" 
                                       Margin="Margin.Dense"
                                       Class="rounded-xl"
                                       AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="50">50</MudSelectItem>
                                <MudSelectItem Value="100">100</MudSelectItem>
                                <MudSelectItem Value="200">200</MudSelectItem>
                                <MudSelectItem Value="500">500</MudSelectItem>
                            </MudSelect>
                        </div>
                        <div class="flex items-end gap-2">
                            <UIButton Variant="primary" Size="md" OnClick="@BuscarAsync" IsLoading="@isLoading">Buscar</UIButton>
                            <UIButton Variant="ghost" Size="md" OnClick="@LimpiarFiltros">Limpiar</UIButton>
                        </div>
                    </div>
                </div>

                <!-- Resultados: Tabla o Timeline -->
                @if (isLoading)
                {
                    <div class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <p class="mt-4 text-slate-500">Cargando registros de auditoría...</p>
                    </div>
                }
                else if (logs == null || !logs.Any())
                {
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="mt-4 text-slate-500">No se encontraron registros de auditoría</p>
                    </div>
                }
                else
                {
                    @if (vistaTimeline)
                    {
                        <!-- Vista Timeline -->
                        <AuditoriaTimeline Logs="@logs" />
                        
                        <div class="mt-4 text-sm text-slate-500">
                            Mostrando @logs.Count registro(s)
                        </div>
                    }
                    else
                    {
                        <!-- Vista Tabla -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                                <thead class="bg-slate-50 dark:bg-slate-800">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha/Hora</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Usuario</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Entidad</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Acción</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Detalles</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-700">
                                    @foreach (var log in logs)
                                    {
                                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                                <div>@log.Timestamp.ToString("dd/MM/yyyy")</div>
                                                <div class="text-xs text-slate-500">@log.Timestamp.ToString("HH:mm:ss")</div>
                                            </td>
                                            <td class="px-4 py-3 text-sm">
                                                <div class="font-medium">@ObtenerNombreCorto(log.UserName)</div>
                                                <div class="text-xs text-slate-500">@log.UserName</div>
                                            </td>
                                            <td class="px-4 py-3 text-sm">
                                                <UIBadge Variant="@ObtenerColorEntidad(log.EntityType)">@ObtenerNombreEntidad(log.EntityType)</UIBadge>
                                                <div class="text-xs text-slate-500 mt-1 font-mono">@log.EntityId.Substring(0, 8)...</div>
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <UIBadge Variant="@ObtenerColorAccion(log.Action)">@ObtenerNombreAccion(log.Action)</UIBadge>
                                            </td>
                                            <td class="px-4 py-3 text-sm max-w-md">
                                                @if (!string.IsNullOrWhiteSpace(log.AdditionalInfo))
                                                {
                                                    <div class="truncate" title="@log.AdditionalInfo">@log.AdditionalInfo</div>
                                                }
                                                else
                                                {
                                                    <span class="text-slate-400 italic">Sin información adicional</span>
                                                }
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                                <button @onclick="() => MostrarDetalleLog(log)" class="text-primary hover:text-primary-dark">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 text-sm text-slate-500">
                            Mostrando @logs.Count registro(s)
                        </div>
                    }
                }
            </ChildContent>
        </UICard>

        <!-- Modal de detalles -->
        @if (mostrarModalDetalle && logSeleccionado != null)
        {
            <UIModal IsOpen="@mostrarModalDetalle" IsOpenChanged="@((bool open) => mostrarModalDetalle = open)" Class="max-w-4xl">
                <Header>
                    <h3 class="text-lg font-semibold">Detalles del Registro de Auditoría</h3>
                </Header>
                <ChildContent>
                    <div class="space-y-4">
                        <!-- Información General -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Fecha y Hora</label>
                                <p class="text-sm">@logSeleccionado.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Usuario</label>
                                <p class="text-sm">@logSeleccionado.UserName</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo de Entidad</label>
                                <p class="text-sm">@ObtenerNombreEntidad(logSeleccionado.EntityType)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">ID de Entidad</label>
                                <p class="text-sm font-mono">@logSeleccionado.EntityId</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Acción</label>
                                <p class="text-sm">@ObtenerNombreAccion(logSeleccionado.Action)</p>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(logSeleccionado.IpAddress))
                            {
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Dirección IP</label>
                                    <p class="text-sm">@logSeleccionado.IpAddress</p>
                                </div>
                            }
                        </div>

                        <!-- Información Adicional -->
                        @if (!string.IsNullOrWhiteSpace(logSeleccionado.AdditionalInfo))
                        {
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Información Adicional</label>
                                <div class="bg-slate-50 dark:bg-slate-800 rounded-lg p-4">
                                    <p class="text-sm">@logSeleccionado.AdditionalInfo</p>
                                </div>
                            </div>
                        }

                        <!-- Valores Anteriores -->
                        @if (!string.IsNullOrWhiteSpace(logSeleccionado.OldValues))
                        {
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Valores Anteriores</label>
                                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 overflow-x-auto">
                                    <pre class="text-xs font-mono">@FormatearJson(logSeleccionado.OldValues)</pre>
                                </div>
                            </div>
                        }

                        <!-- Valores Nuevos -->
                        @if (!string.IsNullOrWhiteSpace(logSeleccionado.NewValues))
                        {
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Valores Nuevos</label>
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 overflow-x-auto">
                                    <pre class="text-xs font-mono">@FormatearJson(logSeleccionado.NewValues)</pre>
                                </div>
                            </div>
                        }
                    </div>
                </ChildContent>
                <Footer>
                    <UIButton Variant="ghost" OnClick="@(() => CerrarModalDetalle())">Cerrar</UIButton>
                </Footer>
            </UIModal>
        }

@code {
    private List<AuditLog> logs = new();
    private bool isLoading = false;
    private bool vistaTimeline = false;

    private List<Server.Components.Shared.Breadcrumb.BreadcrumbItem> breadcrumbs => new()
    {
        new() { Label = "Administración", Url = "/admin" },
        new() { Label = "Auditoría", IsActive = true }
    };

    // Filtros
    private string filtroEntityType = "";
    private string filtroAction = "";
    private string filtroUserName = "";
    private string filtroEntityId = "";
    private DateTime? filtroFechaDesde = DateTime.Now.AddMonths(-1);
    private DateTime? filtroFechaHasta = DateTime.Now;
    private int cantidadRegistros = 100;

    // Modal
    private bool mostrarModalDetalle = false;
    private AuditLog? logSeleccionado = null;

    // Debounce para búsqueda de usuario
    private CancellationTokenSource? _ctsBusquedaUsuario;
    private const int DebounceMilliseconds = 300;

    protected override async Task OnInitializedAsync()
    {
        await BuscarAsync();
    }

    /// <summary>
    /// Manejador de cambio en el filtro de tipo de entidad con búsqueda automática.
    /// </summary>
    private async Task OnEntityTypeChanged(string value)
    {
        filtroEntityType = value;
        await BuscarAsync();
    }

    /// <summary>
    /// Manejador de cambio en el filtro de acción con búsqueda automática.
    /// </summary>
    private async Task OnActionChanged(string value)
    {
        filtroAction = value;
        await BuscarAsync();
    }

    /// <summary>
    /// Manejador de cambio en el filtro de usuario con debounce de 300ms.
    /// Cancela búsqueda anterior y programa nueva después del delay.
    /// </summary>
    private async Task OnUserNameChanged(string value)
    {
        filtroUserName = value;
        
        // Cancelar búsqueda anterior si existe
        _ctsBusquedaUsuario?.Cancel();
        _ctsBusquedaUsuario = new CancellationTokenSource();
        
        try
        {
            // Esperar 300ms antes de buscar
            await Task.Delay(DebounceMilliseconds, _ctsBusquedaUsuario.Token);
            await BuscarAsync();
        }
        catch (TaskCanceledException)
        {
            // Ignorar si fue cancelado por un nuevo cambio
        }
    }

    /// <summary>
    /// Ejecuta la búsqueda de eventos de auditoría aplicando filtros activos.
    /// - Si se especifica un EntityId, consulta focalizada por entidad.
    /// - Caso contrario, trae los registros recientes y filtra en memoria.
    /// </summary>
    private async Task BuscarAsync()
    {
        isLoading = true;
        try
        {
            // Si hay entityId específico, buscar por entidad
            if (!string.IsNullOrWhiteSpace(filtroEntityId))
            {
                logs = await AuditService.GetEntityLogsAsync(filtroEntityType, filtroEntityId);
            }
            else
            {
                // Obtener logs recientes
                logs = await AuditService.GetRecentLogsAsync(cantidadRegistros);
            }

            // Aplicar filtros en memoria (case-insensitive cuando aplica)
            var query = logs.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(filtroEntityType))
                query = query.Where(l => string.Equals(l.EntityType, filtroEntityType, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(filtroAction))
                query = query.Where(l => string.Equals(l.Action, filtroAction, StringComparison.OrdinalIgnoreCase));

            if (!string.IsNullOrWhiteSpace(filtroUserName))
                query = query.Where(l => l.UserName.Contains(filtroUserName, StringComparison.OrdinalIgnoreCase));

            if (filtroFechaDesde.HasValue)
                query = query.Where(l => l.Timestamp >= filtroFechaDesde.Value);

            if (filtroFechaHasta.HasValue)
                query = query.Where(l => l.Timestamp <= filtroFechaHasta.Value.AddDays(1));

            logs = query.OrderByDescending(l => l.Timestamp).ToList();
        }
        catch (Exception ex)
        {
            // Feedback de error al usuario y log en consola para diagnóstico
            Toast?.ShowError($"Error al buscar auditoría: {ex.Message}");
}
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Restablece todos los filtros a los valores por defecto para una búsqueda fresca.
    /// </summary>
    private async Task LimpiarFiltros()
    {
        filtroEntityType = "";
        filtroAction = "";
        filtroUserName = "";
        filtroEntityId = "";
        filtroFechaDesde = DateTime.Now.AddMonths(-1);
        filtroFechaHasta = DateTime.Now;
        cantidadRegistros = 100;
        await BuscarAsync();
    }

    /// <summary>
    /// Abre el modal con los detalles del registro seleccionado.
    /// </summary>
    private void MostrarDetalleLog(AuditLog log)
    {
        logSeleccionado = log;
        mostrarModalDetalle = true;
    }

    /// <summary>
    /// Cierra el modal de detalle y limpia la selección actual.
    /// </summary>
    private void CerrarModalDetalle()
    {
        mostrarModalDetalle = false;
        logSeleccionado = null;
    }

    /// <summary>
    /// Obtiene el alias corto del usuario (antes del @). Si está vacío, retorna "Sistema".
    /// </summary>
    private string ObtenerNombreCorto(string userName)
    {
        if (string.IsNullOrWhiteSpace(userName)) return "Sistema";
        var parts = userName.Split('@');
        return parts.Length > 0 ? parts[0] : userName;
    }

    /// <summary>
    /// Mapea el tipo de entidad a una etiqueta amigable. Acepta valores en distintos formatos/casos.
    /// </summary>
    private string ObtenerNombreEntidad(string entityType)
    {
        var e = entityType?.Trim();
        if (string.IsNullOrEmpty(e)) return string.Empty;
        var key = e.ToUpperInvariant();
        return key switch
        {
            "CERTIFICADODONACION" or "CERTIFICADO" => "Certificado",
            "RECIBO" => "Recibo",
            "MIEMBRO" => "Miembro",
            "EGRESO" => "Egreso",
            "CIERREMENSUAL" or "CIERRE_CONTABLE" or "CIERRE" => "Cierre",
            _ => entityType ?? string.Empty
        };
    }

    /// <summary>
    /// Devuelve la variante de color para el tipo de entidad (para UIBadge).
    /// </summary>
    private string ObtenerColorEntidad(string entityType)
    {
        var e = entityType?.Trim();
        if (string.IsNullOrEmpty(e)) return "default";
        var key = e.ToUpperInvariant();
        return key switch
        {
            "CERTIFICADODONACION" or "CERTIFICADO" => "success",
            "RECIBO" => "primary",
            "MIEMBRO" => "info",
            "EGRESO" => "warning",
            "CIERREMENSUAL" or "CIERRE_CONTABLE" or "CIERRE" => "danger",
            _ => "default"
        };
    }

    /// <summary>
    /// Traduce la acción a una etiqueta amigable.
    /// </summary>
    private string ObtenerNombreAccion(string action)
    {
        var a = action?.Trim();
        if (string.IsNullOrEmpty(a)) return "";
        var key = a.ToUpperInvariant();
        return key switch
        {
            "EMITTED" or "EMITIDO" => "Emitido",
            "ANNULLED" or "ANULADO" => "Anulado",
            "CREATED" or "CREADO" => "Creado",
            "UPDATED" or "ACTUALIZADO" => "Actualizado",
            "DELETED" or "ELIMINADO" => "Eliminado",
            _ => a
        };
    }

    /// <summary>
    /// Variante de color asociada a la acción realizada.
    /// </summary>
    private string ObtenerColorAccion(string action)
    {
        var a = action?.Trim();
        if (string.IsNullOrEmpty(a)) return "default";
        var key = a.ToUpperInvariant();
        return key switch
        {
            "EMITTED" or "EMITIDO" or "CREATED" or "CREADO" => "success",
            "ANNULLED" or "ANULADO" or "DELETED" or "ELIMINADO" => "danger",
            "UPDATED" or "ACTUALIZADO" => "info",
            _ => "default"
        };
    }

    /// <summary>
    /// Intenta formatear un string JSON para visualización legible; si falla, retorna el original.
    /// </summary>
    private string FormatearJson(string json)
    {
        if (string.IsNullOrWhiteSpace(json)) return "";
        try
        {
            var jsonElement = JsonSerializer.Deserialize<JsonElement>(json);
            return JsonSerializer.Serialize(jsonElement, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }

    /// <summary>
    /// Exporta a CSV los registros actualmente filtrados y dispara la descarga en el navegador.
    /// Reporta éxito o error mediante Toasts.
    /// </summary>
    private async Task ExportarCsv()
    {
        try
        {
            // Exportar los logs actualmente filtrados
            var csvBytes = await CsvExportService.ExportarAuditoriaAsync(logs);
            
            // Generar nombre de archivo con timestamp
            var fileName = $"auditoria_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            // Descargar archivo usando JavaScript
            await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", Convert.ToBase64String(csvBytes));
            Toast?.ShowSuccess($"Archivo {fileName} generado");
        }
        catch (Exception ex)
        {
            Toast?.ShowError($"Error al exportar CSV: {ex.Message}");
}
    }
}
