@page "/admin/import-tesoreria"
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using Server.Services.Import
@using Server.Services.CierreContable
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Nav
@inject CierreContableService CierreService

<PageTitle>Importar Hist√≥rico Tesorer√≠a</PageTitle>

<h3>Importar Hist√≥rico de Tesorer√≠a desde Excel</h3>

<div class="alert alert-info mb-4" role="alert">
    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Esta herramienta importa el hist√≥rico de tesorer√≠a desde archivos Excel <code>.xlsx</code>.
    La importaci√≥n es <strong>idempotente</strong>: puede ejecutarse m√∫ltiples veces sin duplicar datos.
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        <strong>‚ö†Ô∏è Error:</strong> @errorMessage
    </div>
}

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üìÅ Seleccionar Archivo Excel</h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label for="fileInput" class="form-label">Archivo .xlsx:</label>
            <InputFile id="fileInput" @ref="fileInput" accept=".xlsx" class="form-control" OnChange="OnFileSelected" />
            @if (selectedFile != null)
            {
                <small class="text-muted d-block mt-2">
                    ‚úì Archivo seleccionado: <strong>@selectedFile.Name</strong> (@FormatFileSize(selectedFile.Size))
                </small>
            }
        </div>

        @if (cierresMensuales.Any())
        {
            <div class="alert alert-warning mt-3" role="alert">
                <strong>üîí Meses Cerrados:</strong> Los siguientes per√≠odos ya est√°n cerrados y no pueden ser importados:
                <ul class="mb-0 mt-2">
                    @foreach (var cierre in cierresMensuales)
                    {
                        <li>@($"{ObtenerNombreMes(cierre.Mes)} {cierre.Ano} - Cerrado por {cierre.UsuarioCierre} el {cierre.FechaCierre:dd/MM/yyyy}")</li>
                    }
                </ul>
                <small class="d-block mt-2">Si necesita re-importar un mes cerrado, contacte a un administrador para reabrirlo.</small>
            </div>
        }

        <div class="form-check mb-3">
            <InputCheckbox id="understandsCheckbox" @bind-Value="understandsRisk" class="form-check-input" />
            <label class="form-check-label" for="understandsCheckbox">
                Entiendo que esta es una operaci√≥n irreversible y puedo revisar el Dry Run primero
            </label>
        </div>

        <div class="mb-3">
            <label for="confirmText" class="form-label">
                Escribe <strong>"IMPORTAR HISTORICO"</strong> para confirmar importaci√≥n real:
            </label>
            <input type="text" id="confirmText" class="form-control" @bind="confirmText" 
                   placeholder="Escriba el texto exacto..." />
            <small class="text-muted d-block mt-1">
                Este texto es requerido solo para la importaci√≥n real (no para Dry Run)
            </small>
        </div>

        <div class="btn-group" role="group">
            <button class="btn btn-warning" @onclick="RunDryRun" 
                    disabled="@(isProcessing || selectedFile == null || !understandsRisk)">
                @if (isProcessing && isDryRun)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Procesando...</span>
                }
                else
                {
                    <span>üß™ Dry Run (Simular)</span>
                }
            </button>
            <button class="btn btn-success" @onclick="RunImport" 
                    disabled="@(isProcessing || selectedFile == null || !understandsRisk || !IsConfirmed)">
                @if (isProcessing && !isDryRun)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Importando...</span>
                }
                else
                {
                    <span>‚úÖ Importar (Real)</span>
                }
            </button>
        </div>
    </div>
</div>

@if (summary != null)
{
    <div class="card mb-4">
        <div class="card-header bg-@(summary.Success ? "success" : "warning") text-white">
            <h5 class="mb-0">@(isDryRun ? "üß™ Resultado Dry Run" : "‚úÖ Resultado de Importaci√≥n")</h5>
        </div>
        <div class="card-body">
            <p class="mb-3"><strong>@summary.Message</strong></p>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Filas Procesadas</h6>
                            <h3>@summary.TotalRowsProcessed</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Importados</h6>
                            <h3 class="text-success">@summary.MovimientosImported</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Omitidos (ya exist√≠an)</h6>
                            <h3 class="text-secondary">@summary.MovimientosSkipped</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="text-muted">Mismatches de Saldo</h6>
                            <h3 class="@(summary.BalanceMismatches > 0 ? "text-warning" : "text-success")">@summary.BalanceMismatches</h3>
                        </div>
                    </div>
                </div>
            </div>

            @if (summary.MovimientosPorHoja.Any())
            {
                <h6 class="mt-4">Movimientos por Hoja:</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Hoja</th>
                            <th class="text-end">Movimientos</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var kv in summary.MovimientosPorHoja.OrderBy(x => x.Key))
                        {
                            <tr>
                                <td>@kv.Key</td>
                                <td class="text-end">@kv.Value</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            @if (summary.SaldoFinalCalculado.HasValue)
            {
                <div class="alert alert-info mt-3" role="alert">
                    <strong>Saldo Final Calculado:</strong> @($"{summary.SaldoFinalCalculado.Value:N0} COP")
                    @if (summary.SaldoFinalEsperado.HasValue)
                    {
                        <br />
                        <strong>Saldo Esperado (Excel):</strong> @($"{summary.SaldoFinalEsperado.Value:N0} COP")
                    }
                </div>
            }

            @if (summary.Warnings.Any())
            {
                <div class="alert alert-warning mt-3" role="alert">
                    <h6>‚ö†Ô∏è Advertencias (@summary.Warnings.Count):</h6>
                    <ul class="mb-0">
                        @foreach (var warning in summary.Warnings.Take(20))
                        {
                            <li>@warning</li>
                        }
                        @if (summary.Warnings.Count > 20)
                        {
                            <li><em>... y @(summary.Warnings.Count - 20) advertencias m√°s.</em></li>
                        }
                    </ul>
                </div>
            }

            @if (summary.Errors.Any())
            {
                <div class="alert alert-danger mt-3" role="alert">
                    <h6>‚ùå Errores:</h6>
                    <ul class="mb-0">
                        @foreach (var error in summary.Errors)
                        {
                            <li>@error</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
}

<div class="btn-group" role="group">
    <button class="btn btn-primary" @onclick="RunDryRun" disabled="@isProcessing">
        @if (isProcessing && isDryRun)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Procesando...</span>
        }
        else
        {
            <span>üß™ Dry Run (Simular)</span>
        }
    </button>
    <button class="btn btn-success" @onclick="RunImport" disabled="@isProcessing">
        @if (isProcessing && !isDryRun)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Importando...</span>
        }
        else
        {
            <span>‚úÖ Importar (Real)</span>
        }
    </button>
</div>

<div class="mt-4">
    <a href="/tesoreria/movimientos" class="btn btn-link">Ver Movimientos de Tesorer√≠a</a>
    <a href="/tesoreria/cuentas-financieras" class="btn btn-link">Ver Cuentas Financieras</a>
</div>

@code {
    private const string ConfirmPhrase = "IMPORTAR HISTORICO";
    
    private InputFile? fileInput;
    private IBrowserFile? selectedFile;
    private ImportSummary? summary;
    private string? errorMessage;
    private bool isProcessing;
    private bool isDryRun;
    private bool understandsRisk;
    private string confirmText = "";
    private List<CierreMensual> cierresMensuales = new();

    private bool IsConfirmed => string.Equals(confirmText?.Trim(), ConfirmPhrase, StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        // Cargar lista de cierres una sola vez
        cierresMensuales = await CierreService.ObtenerCierresAsync();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        summary = null;
        errorMessage = null;
        confirmText = "";
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024:F1} KB";
        return $"{bytes / (1024 * 1024):F1} MB";
    }

    private async Task RunDryRun()
    {
        if (selectedFile == null || !understandsRisk)
            return;
        
        isDryRun = true;
        await ExecuteImport(dryRun: true);
    }

    private async Task RunImport()
    {
        if (selectedFile == null || !understandsRisk || !IsConfirmed)
            return;
        
        isDryRun = false;
        await ExecuteImport(dryRun: false);
    }

    private async Task ExecuteImport(bool dryRun)
    {
        isProcessing = true;
        errorMessage = null;
        summary = null;
        StateHasChanged();

        Stream? fileStream = null;
        try
        {
            if (selectedFile == null)
            {
                errorMessage = "Debe seleccionar un archivo";
                return;
            }

            // Crear contenido multipart/form-data
            using var content = new MultipartFormDataContent();
            
            // Leer archivo y agregarlo al contenido (NO usar using para el stream aqu√≠)
            fileStream = selectedFile.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10 MB max
            var streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new MediaTypeHeaderValue("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            content.Add(streamContent, "file", selectedFile.Name);

            // Hacer POST al endpoint (el stream sigue vivo)
            var response = await Http.PostAsync($"/api/admin/import/tesoreria/excel?dryRun={dryRun}", content);
            
            if (response.IsSuccessStatusCode)
            {
                summary = await response.Content.ReadFromJsonAsync<ImportSummary>();
                // Limpiar confirmText despu√©s de importar exitosamente
                if (!dryRun && summary?.Success == true)
                    confirmText = "";
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error HTTP {response.StatusCode}: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Excepci√≥n: {ex.Message}";
        }
        finally
        {
            fileStream?.Dispose();
            isProcessing = false;
            StateHasChanged();
        }
    }

    private string ObtenerNombreMes(int mes) => mes switch
    {
        1 => "Enero",
        2 => "Febrero",
        3 => "Marzo",
        4 => "Abril",
        5 => "Mayo",
        6 => "Junio",
        7 => "Julio",
        8 => "Agosto",
        9 => "Septiembre",
        10 => "Octubre",
        11 => "Noviembre",
        12 => "Diciembre",
        _ => mes.ToString()
    };
}
