@page "/config/usuarios"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Server.Data
@using Server.Models
@attribute [Authorize(Policy = "AdminOrTesoreroWith2FA")]
@inject IDbContextFactory<AppDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Nav
@inject Server.Services.Audit.IAuditService Audit

<PageTitle>Usuarios y Roles</PageTitle>

<Breadcrumb Items="@breadcrumbs" />

<UICard Class="mb-6">
    <Header>
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a4 4 0 0 0-3-3.87" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 20H4v-2a4 4 0 0 1 3-3.87" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />
            </svg>
            <span class="text-2xl font-semibold">Gestión de Usuarios</span>
        </div>
        <div class="flex gap-2">
            <UIButton Variant="primary" Size="sm" OnClick="@AbrirModalNuevoUsuario">Nuevo Usuario</UIButton>
            <UIButton Variant="ghost" Size="sm" OnClick="@LoadAsync" IsLoading="@IsLoading">Refrescar</UIButton>
        </div>
    </Header>
    <ChildContent>
        <div class="glass-card p-4 rounded-2xl mb-4 backdrop-blur-lg bg-white/80 dark:bg-slate-900/80 border border-slate-200/50 dark:border-slate-700/50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Buscar</label>
                    <MudTextField T="string"
                                  Value="@Filtro"
                                  ValueChanged="@OnFiltroChanged"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Placeholder="correo o nombre"
                                  Class="rounded-xl"
                                  Immediate="true" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rol</label>
                    <MudSelect T="string"
                               Value="@FiltroRol"
                               ValueChanged="@(v => { FiltroRol = v ?? string.Empty; StateHasChanged(); })"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Class="rounded-xl">
                        <MudSelectItem Value="@string.Empty">Todos</MudSelectItem>
                        @foreach (var r in RolesDisponibles)
                        {
                            <MudSelectItem Value="@r">@r</MudSelectItem>
                        }
                    </MudSelect>
                </div>
                <div class="flex items-end">
                    <UIButton Variant="primary" OnClick="@Filtrar">Aplicar Filtros</UIButton>
                </div>
            </div>
        </div>

        @if (IsLoading)
        {
            <div class="py-8 text-center text-slate-500">Cargando usuarios...</div>
        }
        else if (UsuariosFiltrados.Count == 0)
        {
            <div class="py-8 text-center text-slate-500">No hay usuarios</div>
        }
        else
        {
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Roles</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        @foreach (var u in UsuariosFiltrados)
                        {
                            <tr>
                                <td class="px-4 py-3 text-sm">@u.Email</td>
                                <td class="px-4 py-3 text-sm">
                                    @if (u.LockoutEnd.HasValue && u.LockoutEnd.Value > DateTimeOffset.UtcNow)
                                    {
                                        <UIBadge Variant="danger">Desactivado</UIBadge>
                                    }
                                    else
                                    {
                                        <UIBadge Variant="success">Activo</UIBadge>
                                    }
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <div class="flex flex-wrap gap-1">
                                        @foreach (var r in u.Roles)
                                        {
                                            <UIBadge Variant="info">@r</UIBadge>
                                        }
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-sm whitespace-nowrap">
                                    <div class="flex items-center gap-2">
                                        <select class="rounded-lg border-slate-300" @onchange="async e => await CambiarRolAsync(u, e.Value?.ToString())">
                                            <option value="">— Asignar rol —</option>
                                            @foreach (var r in RolesDisponibles)
                                            {
                                                <option value="@r">@r</option>
                                            }
                                        </select>
                                        @if (u.LockoutEnd.HasValue && u.LockoutEnd.Value > DateTimeOffset.UtcNow)
                                        {
                                            <UIButton Variant="success" Size="sm" OnClick="@(() => ActivarAsync(u))">Activar</UIButton>
                                        }
                                        else
                                        {
                                            <UIButton Variant="danger" Size="sm" OnClick="@(() => DesactivarAsync(u))">Desactivar</UIButton>
                                        }
                                        <UIButton Variant="ghost" Size="sm" OnClick="@(() => ResetPasswordAsync(u))">Reset Clave</UIButton>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </ChildContent>
</UICard>

@if (MostrarModalNuevo)
{
    <UIModal IsOpen="@MostrarModalNuevo" IsOpenChanged="@(open => MostrarModalNuevo = open)" Class="max-w-lg">
        <Header>
            <h3 class="text-lg font-semibold">Crear Nuevo Usuario</h3>
        </Header>
        <ChildContent>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Correo institucional</label>
                    <MudTextField T="string"
                                  @bind-Value="NuevoEmail"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Placeholder="usuario@fundacionlamamedellin.org"
                                  Class="rounded-xl" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rol</label>
                    <MudSelect T="string" @bind-Value="NuevoRol" Variant="Variant.Outlined" Margin="Margin.Dense" Class="rounded-xl">
                        @foreach (var r in RolesDisponibles)
                        {
                            <MudSelectItem Value="@r">@r</MudSelectItem>
                        }
                    </MudSelect>
                </div>
            </div>
        </ChildContent>
        <Footer>
            <UIButton Variant="ghost" OnClick="@(() => MostrarModalNuevo = false)">Cancelar</UIButton>
            <UIButton Variant="primary" OnClick="@CrearUsuarioAsync" IsLoading="@IsLoading">Crear</UIButton>
        </Footer>
    </UIModal>
}

@code {
    private List<UsuarioVM> UsuariosLista = new();
    private List<UsuarioVM> UsuariosFiltrados => AplicarFiltros();
    private List<string> RolesDisponibles = new();
    private bool IsLoading = false;
    private string Filtro = string.Empty;
    private string FiltroRol = string.Empty;
    private CancellationTokenSource? _debounceCts;

    private bool MostrarModalNuevo = false;
    private string NuevoEmail = string.Empty;
    private string NuevoRol = "Tesorero";

    private List<Server.Components.Shared.Breadcrumb.BreadcrumbItem> breadcrumbs => new()
    {
        new() { Label = "Configuración", Url = "/config" },
        new() { Label = "Usuarios", IsActive = true }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    /// <summary>
    /// Carga la lista de usuarios y roles usando DbContextFactory para evitar conflictos de concurrencia.
    /// Usa una instancia dedicada de DbContext para evitar colisiones con otros componentes (ej. TwoFactorWarningBanner)
    /// que pueden estar accediendo al mismo DbContext simultáneamente durante OnInitializedAsync.
    /// </summary>
    private async Task LoadAsync()
    {
        IsLoading = true;
        try
        {
            // Crear instancia dedicada de DbContext usando factory para evitar conflictos de concurrencia
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Cargar roles directamente desde DbContext dedicado
            RolesDisponibles = await db.Roles
                .Select(r => r.Name!)
                .OrderBy(n => n)
                .ToListAsync();
            
                // Cargar usuarios y roles sin usar UserManager para evitar concurrencia
                var users = await db.Users.ToListAsync();
                var userRoles = await db.UserRoles.ToListAsync();
                var rolesDict = await db.Roles.ToDictionaryAsync(r => r.Id, r => r.Name ?? string.Empty);

                UsuariosLista = users.Select(u => new UsuarioVM
                {
                    Id = u.Id,
                    Email = u.Email ?? u.UserName ?? string.Empty,
                    LockoutEnd = u.LockoutEnd,
                    Roles = userRoles.Where(ur => ur.UserId == u.Id)
                                       .Select(ur => rolesDict.TryGetValue(ur.RoleId, out var rn) ? rn : string.Empty)
                                       .Where(n => !string.IsNullOrWhiteSpace(n))
                                       .Distinct()
                                       .OrderBy(n => n)
                                       .ToList()
                }).ToList();
        }
        finally { IsLoading = false; }
    }

    private List<UsuarioVM> AplicarFiltros()
    {
    IEnumerable<UsuarioVM> q = UsuariosLista;
        if (!string.IsNullOrWhiteSpace(Filtro))
        {
            var f = Filtro.Trim().ToLowerInvariant();
            q = q.Where(u => (u.Email ?? string.Empty).ToLowerInvariant().Contains(f));
        }
        if (!string.IsNullOrWhiteSpace(FiltroRol))
        {
            q = q.Where(u => u.Roles.Contains(FiltroRol));
        }
        return q.OrderBy(u => u.Email).ToList();
    }

    private void Filtrar() { /* filtros aplican con binding; este botón sirve de ancla UX */ }

    private async void OnFiltroChanged(string? value)
    {
        _debounceCts?.Cancel();
        _debounceCts = new CancellationTokenSource();
        var token = _debounceCts.Token;
        
        Filtro = value ?? string.Empty;
        
        try
        {
            await Task.Delay(300, token);
            if (!token.IsCancellationRequested)
            {
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (TaskCanceledException) { }
    }

    private void AbrirModalNuevoUsuario()
    {
        NuevoEmail = string.Empty;
        NuevoRol = "Tesorero";
        MostrarModalNuevo = true;
    }

    private async Task CambiarRolAsync(UsuarioVM u, string? nuevoRol)
    {
        if (string.IsNullOrWhiteSpace(nuevoRol)) return;
        var user = await UserManager.FindByIdAsync(u.Id);
        if (user is null) return;
        var rolesActuales = await UserManager.GetRolesAsync(user);
        // Quitar otros roles y asignar el nuevo (rol principal único para simplificar)
        if (rolesActuales.Count > 0)
            await UserManager.RemoveFromRolesAsync(user, rolesActuales);
        await UserManager.AddToRoleAsync(user, nuevoRol);
        u.Roles = new List<string> { nuevoRol };
        await Audit.LogAsync("Usuario", user.Id, "Updated", GetCurrentUser(), newValues: new { Rol = nuevoRol }, additionalInfo: $"Asignado rol {nuevoRol} a {u.Email}");
    }

    private async Task ActivarAsync(UsuarioVM u)
    {
        var user = await UserManager.FindByIdAsync(u.Id);
        if (user is null) return;
        user.LockoutEnd = null;
        await UserManager.UpdateAsync(user);
        u.LockoutEnd = null;
        await Audit.LogAsync("Usuario", user.Id, "Updated", GetCurrentUser(), newValues: new { Activo = true }, additionalInfo: $"Activado usuario {u.Email}");
    }

    private async Task DesactivarAsync(UsuarioVM u)
    {
        var user = await UserManager.FindByIdAsync(u.Id);
        if (user is null) return;
        user.LockoutEnd = DateTimeOffset.MaxValue;
        await UserManager.UpdateAsync(user);
        u.LockoutEnd = user.LockoutEnd;
        await Audit.LogAsync("Usuario", user.Id, "Updated", GetCurrentUser(), newValues: new { Activo = false }, additionalInfo: $"Desactivado usuario {u.Email}");
    }

    private async Task ResetPasswordAsync(UsuarioVM u)
    {
        var user = await UserManager.FindByIdAsync(u.Id);
        if (user is null) return;
        // Generar una clave temporal segura y establecerla (se muestra un toast/alerta; ideal sería enviar email)
        var tempPw = $"Tmp!{Guid.NewGuid().ToString("N").Substring(0, 8)}a1";
        var token = await UserManager.GeneratePasswordResetTokenAsync(user);
        var res = await UserManager.ResetPasswordAsync(user, token, tempPw);
        if (res.Succeeded)
        {
            await Audit.LogAsync("Usuario", user.Id, "Updated", GetCurrentUser(), additionalInfo: $"Reset de clave para {u.Email}");
            // Nota: puedes integrar un ToastService para mostrar la clave temporal. Por ahora, usar alert simple.
            await JS.InvokeVoidAsync("alert", $"Clave temporal para {u.Email}: {tempPw}");
        }
    }

    private async Task CrearUsuarioAsync()
    {
        if (string.IsNullOrWhiteSpace(NuevoEmail)) return;
        if (!NuevoEmail.EndsWith("@fundacionlamamedellin.org", StringComparison.OrdinalIgnoreCase))
        {
            await JS.InvokeVoidAsync("alert", "El correo debe ser del dominio @fundacionlamamedellin.org");
            return;
        }
        var uExist = await UserManager.FindByEmailAsync(NuevoEmail);
        if (uExist is not null)
        {
            await JS.InvokeVoidAsync("alert", "Ya existe un usuario con ese correo");
            return;
        }
        var user = new ApplicationUser { UserName = NuevoEmail, Email = NuevoEmail, EmailConfirmed = true };
        var tempPw = $"Tmp!{Guid.NewGuid().ToString("N").Substring(0, 8)}a1";
        var res = await UserManager.CreateAsync(user, tempPw);
        if (res.Succeeded)
        {
            if (!string.IsNullOrWhiteSpace(NuevoRol) && await RoleManager.RoleExistsAsync(NuevoRol))
                await UserManager.AddToRoleAsync(user, NuevoRol);
            await Audit.LogAsync("Usuario", user.Id, "Created", GetCurrentUser(), newValues: new { Email = NuevoEmail, Rol = NuevoRol });
            MostrarModalNuevo = false;
            NuevoEmail = string.Empty;
            await LoadAsync();
            await JS.InvokeVoidAsync("alert", $"Usuario creado. Clave temporal: {tempPw}");
        }
        else
        {
            var err = string.Join("; ", res.Errors.Select(e => e.Description));
            await JS.InvokeVoidAsync("alert", $"Error: {err}");
        }
    }

    [Inject] private Microsoft.JSInterop.IJSRuntime JS { get; set; } = default!;

    private string GetCurrentUser() => System.Threading.Thread.CurrentPrincipal?.Identity?.Name ?? "admin";

    private class UsuarioVM
    {
        public string Id { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public DateTimeOffset? LockoutEnd { get; set; }
        public List<string> Roles { get; set; } = new();
    }
}
