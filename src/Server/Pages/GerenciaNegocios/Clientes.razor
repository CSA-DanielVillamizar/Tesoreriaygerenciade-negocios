@page "/gerencia-negocios/clientes"
@using Server.DTOs.Clientes
@using Server.Components.Shared
@attribute [Authorize(Policy = "GerenciaNegocios")]
@inject HttpClient Http
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<PageTitle>Clientes - LAMA Medellín</PageTitle>

<Breadcrumb Items="@breadcrumbs" />

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    <MudPaper Class="glass-card pa-6 mb-6">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1"><MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Class="me-2" />Clientes</h2>
                <MudText Typo="Typo.body2" Class="text-muted">Gestión de clientes y ventas</MudText>
            </div>
                <AuthorizeView Policy="GerenciaNegocios">
                <Authorized>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="@(() => Nav.NavigateTo("/gerencia-negocios/clientes/nuevo"))">
                        Nuevo Cliente
                    </MudButton>
                </Authorized>
            </AuthorizeView>
        </div>
    </MudPaper>

    @if (estadisticasCargadas)
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <ModernStatCard 
                    Icon="@Icons.Material.Filled.People"
                    Value="@totalClientes.ToString()"
                    Title="Total Clientes"
                    IconColor="primary" />
            </div>
            <div class="col-md-3">
                <ModernStatCard 
                    Icon="@Icons.Material.Filled.CheckCircle"
                    Value="@clientesActivos.ToString()"
                    Title="Activos"
                    IconColor="success" />
            </div>
            <div class="col-md-3">
                <ModernStatCard 
                    Icon="@Icons.Material.Filled.ShoppingCart"
                    Value="@clientesConVentas.ToString()"
                    Title="Con Ventas"
                    IconColor="info" />
            </div>
            <div class="col-md-3">
                <ModernStatCard 
                    Icon="@Icons.Material.Filled.Star"
                    Value="@puntosTotales.ToString()"
                    Title="Puntos Total"
                    IconColor="warning" />
            </div>
        </div>
    }
    else
    {
        <div class="skeleton skeleton-card mb-4" style="height: 120px;"></div>
    }

    <MudPaper Class="glass-card pa-4 mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <ModernSearch Placeholder="Buscar por nombre, identificación o email..." 
                                 Value="@busqueda" 
                                 ValueChanged="@((value) => { busqueda = value; BuscarConDelay(); })" />
            </div>
            <div class="col-md-2">
                <MudSelect T="string" 
                           Value="@filtroActivo"
                           Label="Estado" 
                           Variant="Variant.Outlined"
                           ValueChanged="@(async (string val) => { filtroActivo = val; await Buscar(); })">
                    <MudSelectItem Value="@("")">Todos</MudSelectItem>
                    <MudSelectItem Value="@("true")">Activos</MudSelectItem>
                    <MudSelectItem Value="@("false")">Inactivos</MudSelectItem>
                </MudSelect>
            </div>
            <div class="col-md-2">
                <MudSelect T="string" 
                           Value="@filtroTipo"
                           Label="Tipo" 
                           Variant="Variant.Outlined"
                           ValueChanged="@(async (string val) => { filtroTipo = val; await Buscar(); })">
                    <MudSelectItem Value="@("")">Todos</MudSelectItem>
                    <MudSelectItem Value="@("Persona Natural")">Persona Natural</MudSelectItem>
                    <MudSelectItem Value="@("Empresa")">Empresa</MudSelectItem>
                </MudSelect>
            </div>
            <div class="col-md-4">
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Default" 
                           FullWidth="true"
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="LimpiarFiltros">
                    Limpiar Filtros
                </MudButton>
            </div>
        </div>
    </MudPaper>

    <MudPaper Class="glass-card pa-4">
        @if (cargando)
        {
            <div class="skeleton skeleton-card mb-4" style="height: 400px;"></div>
        }
        else if (!clientes.Any())
        {
            <div class="text-center py-5">
                <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Class="text-muted mb-3" Style="font-size: 4rem;" />
                <MudText Typo="Typo.body1" Class="text-muted">No se encontraron clientes</MudText>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Identificación</th>
                            <th>Tipo</th>
                            <th>Contacto</th>
                            <th>Puntos</th>
                            <th>Ventas</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cliente in clientes)
                        {
                            <tr>
                                <td><strong>@cliente.Nombre</strong></td>
                                <td>@cliente.Identificacion</td>
                                <td><span class="badge-modern badge-secondary">@cliente.Tipo</span></td>
                                <td>
                                    <div><MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="me-1" />@(cliente.Telefono ?? "-")</div>
                                    <div class="text-muted small"><MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="me-1" />@(cliente.Email ?? "-")</div>
                                </td>
                                <td><span class="badge-modern badge-warning">@cliente.PuntosFidelizacion</span></td>
                                <td>@cliente.TotalVentas</td>
                                <td>
                                    @if (cliente.Activo)
                                    {
                                        <span class="badge-modern badge-success">Activo</span>
                                    }
                                    else
                                    {
                                        <span class="badge-modern badge-secondary">Inactivo</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                       Color="Color.Primary" 
                                                       Size="Size.Small"
                                                       OnClick="@(() => Nav.NavigateTo($"/gerencia-negocios/clientes/{cliente.Id}"))"
                                                       />
                                        <AuthorizeView Policy="GerenciaNegocios">
                                            <Authorized>
                                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                               Color="Color.Default" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => Nav.NavigateTo($"/gerencia-negocios/clientes/editar/{cliente.Id}"))"
                                                               />
                                                <MudIconButton Icon="@(cliente.Activo ? Icons.Material.Filled.Delete : Icons.Material.Filled.Restore)" 
                                                               Color="@(cliente.Activo ? Color.Error : Color.Success)" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => ConfirmarEliminar(cliente))"
                                                               />
                                            </Authorized>
                                        </AuthorizeView>
                                    </MudButtonGroup>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (totalPaginas > 1)
            {
                <div class="d-flex justify-content-center mt-4">
                    <MudPagination Count="@totalPaginas" 
                                   Selected="@paginaActual" 
                                   SelectedChanged="@CambiarPagina" 
                                   Color="Color.Primary" 
                                   ShowFirstButton="true" 
                                   ShowLastButton="true" />
                </div>
                <div class="text-center mt-3">
                    <MudText Typo="Typo.caption" Class="text-muted">
                        Mostrando @((paginaActual - 1) * registrosPorPagina + 1) - @Math.Min(paginaActual * registrosPorPagina, totalClientes) de @totalClientes clientes
                    </MudText>
                </div>
            }
        }
    </MudPaper>
</MudContainer>

<MudDialog @bind-Visible="mostrarModalEliminar">
    <TitleContent>
        <MudText Typo="Typo.h6">Confirmar @(clienteEliminar?.Activo == true ? "Desactivación" : "Activación")</MudText>
    </TitleContent>
    <DialogContent>
        @if (clienteEliminar != null)
        {
            <MudText>¿Está seguro de @(clienteEliminar.Activo ? "desactivar" : "activar") el cliente <strong>@clienteEliminar.Nombre</strong>?</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="CerrarModalEliminar">Cancelar</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="@(clienteEliminar?.Activo == true ? Color.Error : Color.Success)" 
                   OnClick="EliminarCliente"
                   Disabled="@eliminando">
            @if (eliminando)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
            }
            @(clienteEliminar?.Activo == true ? "Desactivar" : "Activar")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ClienteDto> clientes = new();
    private ClienteDto? clienteEliminar;
    private bool cargando = true;
    private bool eliminando = false;
    private bool mostrarModalEliminar = false;
    private bool estadisticasCargadas = false;
    private string busqueda = string.Empty;
    private string filtroActivo = string.Empty;
    private string filtroTipo = string.Empty;
    private int paginaActual = 1;
    private int registrosPorPagina = 20;
    private int totalClientes = 0;
    private int totalPaginas = 0;
    private int clientesActivos = 0;
    private int clientesConVentas = 0;
    private int puntosTotales = 0;
    private System.Threading.Timer? _debounceTimer;

    private List<Server.Components.Shared.Breadcrumb.BreadcrumbItem> breadcrumbs => new()
    {
        new() { Label = "Gerencia de Negocios", Url = "/gerencia-negocios" },
        new() { Label = "Clientes", IsActive = true }
    };

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
        await CargarEstadisticas();
    }

    private async Task CargarClientes()
    {
        cargando = true;
        try
        {
            bool? activoFiltro = string.IsNullOrEmpty(filtroActivo) ? null : bool.Parse(filtroActivo);
            var query = $"?pagina={paginaActual}&registrosPorPagina={registrosPorPagina}";
            if (!string.IsNullOrWhiteSpace(busqueda)) query += $"&busqueda={Uri.EscapeDataString(busqueda)}";
            if (activoFiltro.HasValue) query += $"&activo={activoFiltro.Value}";
            if (!string.IsNullOrWhiteSpace(filtroTipo)) query += $"&tipo={Uri.EscapeDataString(filtroTipo)}";

            // Llamada segura que detecta HTML (login) y estados no autorizados
            var httpResponse = await Http.GetAsync($"/api/clientes{query}");
            if ((int)httpResponse.StatusCode == 401 || (int)httpResponse.StatusCode == 403)
            {
                RedirigirALogin();
                return;
            }
            if (!httpResponse.IsSuccessStatusCode)
            {
                var errorText = await httpResponse.Content.ReadAsStringAsync();
                throw new Exception($"HTTP {(int)httpResponse.StatusCode}: {errorText}");
            }

            var mediaType = httpResponse.Content.Headers.ContentType?.MediaType ?? string.Empty;
            var rawText = mediaType.Contains("json", StringComparison.OrdinalIgnoreCase)
                ? null
                : await httpResponse.Content.ReadAsStringAsync();
            if (rawText != null && rawText.TrimStart().StartsWith("<"))
            {
                // Muy probablemente HTML del Login
                RedirigirALogin();
                return;
            }

            var response = await httpResponse.Content.ReadFromJsonAsync<ClientesListResponse>();
            if (response != null)
            {
                clientes = response.Clientes;
                totalClientes = response.TotalCount;
                totalPaginas = response.TotalPaginas;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar clientes: {ex.Message}", Severity.Error);
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task CargarEstadisticas()
    {
        try
        {
            var httpResponse = await Http.GetAsync("/api/clientes?registrosPorPagina=10000");
            if ((int)httpResponse.StatusCode == 401 || (int)httpResponse.StatusCode == 403)
            {
                // No bloquear la página por estadísticas, pero sugerir login
                RedirigirALogin();
                return;
            }
            if (!httpResponse.IsSuccessStatusCode)
            {
                return; // estadísticas son opcionales
            }
            var mediaType = httpResponse.Content.Headers.ContentType?.MediaType ?? string.Empty;
            if (!mediaType.Contains("json", StringComparison.OrdinalIgnoreCase))
            {
                return;
            }
            var response = await httpResponse.Content.ReadFromJsonAsync<ClientesListResponse>();
            if (response != null)
            {
                clientesActivos = response.Clientes.Count(c => c.Activo);
                clientesConVentas = response.Clientes.Count(c => c.TotalVentas > 0);
                puntosTotales = response.Clientes.Sum(c => c.PuntosFidelizacion);
                estadisticasCargadas = true;
            }
        }
        catch { }
    }

    private void BuscarConDelay()
    {
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                paginaActual = 1;
                await CargarClientes();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task Buscar()
    {
        paginaActual = 1;
        await CargarClientes();
    }

    private async Task LimpiarFiltros()
    {
        busqueda = string.Empty;
        filtroActivo = string.Empty;
        filtroTipo = string.Empty;
        paginaActual = 1;
        await CargarClientes();
    }

    private async Task CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            paginaActual = nuevaPagina;
            await CargarClientes();
        }
    }

    private void ConfirmarEliminar(ClienteDto cliente)
    {
        clienteEliminar = cliente;
        mostrarModalEliminar = true;
    }

    private async Task EliminarCliente()
    {
        if (clienteEliminar == null) return;
        eliminando = true;
        try
        {
            var response = await Http.DeleteAsync($"/api/clientes/{clienteEliminar.Id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(clienteEliminar.Activo ? "Cliente desactivado exitosamente" : "Cliente activado exitosamente", Severity.Success);
                CerrarModalEliminar();
                await CargarClientes();
                await CargarEstadisticas();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
        }
        finally
        {
            eliminando = false;
        }
    }

    private void CerrarModalEliminar()
    {
        mostrarModalEliminar = false;
        clienteEliminar = null;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }

    private void RedirigirALogin()
    {
        var relative = Nav.ToBaseRelativePath(Nav.Uri);
        if (!relative.StartsWith("/")) relative = "/" + relative;
        Nav.NavigateTo($"/Identity/Account/Login?ReturnUrl={Uri.EscapeDataString(relative)}", forceLoad: true);
    }

    public class ClientesListResponse
    {
        public List<ClienteDto> Clientes { get; set; } = new();
        public int TotalCount { get; set; }
        public int Pagina { get; set; }
        public int RegistrosPorPagina { get; set; }
        public int TotalPaginas { get; set; }
    }
}
