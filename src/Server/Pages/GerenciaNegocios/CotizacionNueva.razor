@page "/gerencia-negocios/cotizaciones/nueva"
@using Server.DTOs.Cotizaciones
@using Server.DTOs.Productos
@using Server.DTOs.Clientes
@using Server.Models
@attribute [Authorize(Policy = "GerenciaNegocios")]
@inject HttpClient Http
@inject NavigationManager Nav
@inject ToastService Toast

<PageTitle>Nueva Cotización - LAMA Medellín</PageTitle>

<div class="container-fluid py-4 page-shell cotizacion-nueva">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="/gerencia-negocios/cotizaciones">Cotizaciones</a></li>
                    <li class="breadcrumb-item active">Nueva Cotización</li>
                </ol>
            </nav>
            <div class="page-header">
                <div class="icon-bubble text-primary bg-primary-subtle"><i class="bi bi-file-earmark-plus"></i></div>
                <div>
                    <h2 class="page-title">Nueva Cotización</h2>
                    <div class="page-subtitle text-muted">Completa la información, agrega productos y guarda la cotización.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <FormSection Title="Información General"
                        Description="Datos principales de la cotización"
                        Icon="bi-info-circle"
                        IconColor="info">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Cliente <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="model.TipoCliente" @bind:after="OnTipoClienteChanged">
                            <option value="Miembro">Miembro</option>
                            <option value="Externo">Cliente Externo</option>
                        </select>
                    </div>

                    @if (model.TipoCliente == "Miembro")
                    {
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Miembro <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="model.MiembroId">
                                <option value="">Seleccione un miembro...</option>
                                @foreach (var miembro in miembros)
                                {
                                    <option value="@miembro.Id">@miembro.NombreCompleto</option>
                                }
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cliente <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="model.ClienteId">
                                <option value="">Seleccione un cliente...</option>
                                @foreach (var cliente in clientes)
                                {
                                    <option value="@cliente.Id">@cliente.Nombre (@cliente.Identificacion)</option>
                                }
                            </select>
                        </div>
                    }

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Fecha Cotización <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" @bind="model.FechaCotizacion" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Válida Hasta <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" @bind="model.FechaValidez" />
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-semibold">Observaciones</label>
                        <textarea class="form-control" rows="3" @bind="model.Observaciones" placeholder="Notas adicionales..."></textarea>
                    </div>
                </div>
            </FormSection>

            <FormSection Title="Productos"
                        Description="Agrega los productos a cotizar"
                        Icon="bi-cart"
                        IconColor="success">
                <HeaderAction>
                    <button type="button" class="btn btn-sm btn-primary" @onclick="MostrarModalProductos">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Producto
                    </button>
                </HeaderAction>
                <ChildContent>
                    @if (model.Detalles.Count == 0)
                    {
                        <div class="text-center text-muted py-5 empty-state">
                            <div class="illustration mb-2"><i class="bi bi-cart3"></i></div>
                            <p class="mb-2">No hay productos agregados</p>
                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="MostrarModalProductos">
                                <i class="bi bi-plus-circle me-1"></i> Agregar producto
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm align-middle table-striped">
                                <thead class="table-light small text-uppercase">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-end">Cant.</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Desc.</th>
                                        <th class="text-end">Subtotal</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < model.Detalles.Count; i++)
                                    {
                                        var index = i;
                                        var detalle = model.Detalles[index];
                                        var producto = productos.FirstOrDefault(p => p.Id == detalle.ProductoId);
                                        <tr>
                                            <td>
                                                <strong>@producto?.Nombre</strong>
                                                <br /><small class="text-muted">@producto?.Codigo</small>
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" style="width: 80px;" @bind="detalle.Cantidad" @bind:after="@(() => RecalcularDetalle(index))" min="1" />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" style="width: 120px;" @bind="detalle.PrecioUnitarioCOP" @bind:after="@(() => RecalcularDetalle(index))" min="0" step="100" />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" style="width: 120px;" @bind="detalle.DescuentoCOP" @bind:after="@(() => RecalcularDetalle(index))" min="0" step="100" />
                                            </td>
                                            <td class="text-end"><strong>@detalle.SubtotalCOP.ToString("C0")</strong></td>
                                            <td class="text-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="@(() => EliminarDetalle(index))" title="Eliminar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </ChildContent>
            </FormSection>

            <div class="d-flex justify-content-between actions-bar">
                <button type="button" class="btn btn-secondary" @onclick="@(() => Nav.NavigateTo("/gerencia-negocios/cotizaciones"))">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" @onclick="GuardarCotizacion" disabled="@guardando">
                    @if (guardando)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle me-2"></i>
                    }
                    Guardar Cotización
                </button>
            </div>
        </div>

        <div class="col-lg-4">
            <MudCard Elevation="3" Class="glass-card sticky-top" Style="top: 20px;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <div class="d-flex align-items-center gap-2">
                            <div class="icon-bubble text-warning bg-warning-subtle">
                                <i class="bi bi-calculator"></i>
                            </div>
                            <MudText Typo="Typo.h6" Class="mb-0">Resumen</MudText>
                        </div>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Subtotal:</span>
                        <strong>@CalcularSubtotal().ToString("C0")</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Descuentos:</span>
                        <strong class="text-danger">-@CalcularDescuentos().ToString("C0")</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <span class="h5 mb-0">Total:</span>
                        <span class="h4 mb-0 text-primary"><strong>@CalcularTotal().ToString("C0")</strong></span>
                    </div>
                    <div class="mt-3 text-muted small">
                        <i class="bi bi-cart me-1"></i>@model.Detalles.Count @(model.Detalles.Count == 1 ? "producto" : "productos")
                    </div>
                </MudCardContent>
            </MudCard>
        </div>
    </div>
</div>

@if (mostrarModalProductos)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccionar Producto</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalProductos"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Buscar productos..." @bind="busquedaProducto" @bind:event="oninput" />
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Producto</th>
                                    <th class="text-end">Precio</th>
                                    <th class="text-end">Stock</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var prod in ProductosFiltrados)
                                {
                                    <tr>
                                        <td><small class="text-muted">@prod.Codigo</small></td>
                                        <td><strong>@prod.Nombre</strong></td>
                                        <td class="text-end">@prod.PrecioCOP.ToString("C0")</td>
                                        <td class="text-end">
                                            <span class="badge @(prod.Stock > 0 ? "bg-success" : "bg-warning")">@prod.Stock</span>
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-sm btn-primary" @onclick="@(() => AgregarProducto(prod))">
                                                <i class="bi bi-plus-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalProductos">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private CotizacionFormDto model = new()
    {
        FechaCotizacion = DateTime.Now,
        FechaValidez = DateTime.Now.AddDays(15),
        TipoCliente = "Miembro"
    };

    private List<ProductoListDto> productos = new();
    private List<ClienteDto> clientes = new();
    private List<MiembroSimpleDto> miembros = new();
    private bool guardando = false;
    private bool mostrarModalProductos = false;
    private string busquedaProducto = "";

    private IEnumerable<ProductoListDto> ProductosFiltrados =>
        string.IsNullOrWhiteSpace(busquedaProducto)
            ? productos
            : productos.Where(p =>
                p.Nombre.Contains(busquedaProducto, StringComparison.OrdinalIgnoreCase) ||
                p.Codigo.Contains(busquedaProducto, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            var tasksProductos = Http.GetFromJsonAsync<List<ProductoListDto>>("api/productos?pagina=1&registrosPorPagina=1000");
            var tasksClientes = Http.GetAsync("api/clientes?pagina=1&registrosPorPagina=1000");
            var tasksMiembros = Http.GetFromJsonAsync<List<MiembroSimpleDto>>("api/miembros/simples");

            await Task.WhenAll(tasksProductos, tasksClientes, tasksMiembros!);

            productos = (await tasksProductos) ?? new();
            
            var clientesResponse = await tasksClientes;
            if (clientesResponse.IsSuccessStatusCode)
            {
                var result = await clientesResponse.Content.ReadFromJsonAsync<ClientesResponse>();
                clientes = result?.Clientes ?? new();
            }

            miembros = (await tasksMiembros) ?? new();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error al cargar datos: {ex.Message}");
        }
    }

    private void OnTipoClienteChanged()
    {
        model.ClienteId = null;
        model.MiembroId = null;
    }

    private void MostrarModalProductos()
    {
        mostrarModalProductos = true;
        busquedaProducto = "";
    }

    private void CerrarModalProductos()
    {
        mostrarModalProductos = false;
    }

    private void AgregarProducto(ProductoListDto producto)
    {
        if (model.Detalles.Any(d => d.ProductoId == producto.Id))
        {
            Toast.ShowWarning("Este producto ya está agregado");
            return;
        }

        var detalle = new DetalleCotizacionFormDto
        {
            ProductoId = producto.Id,
            Cantidad = 1,
            PrecioUnitarioCOP = producto.PrecioCOP,
            DescuentoCOP = 0,
            SubtotalCOP = producto.PrecioCOP
        };

        model.Detalles.Add(detalle);
        CerrarModalProductos();
        Toast.ShowSuccess("Producto agregado");
    }

    private void EliminarDetalle(int index)
    {
        model.Detalles.RemoveAt(index);
        Toast.ShowInfo("Producto eliminado");
    }

    private void RecalcularDetalle(int index)
    {
        var detalle = model.Detalles[index];
        detalle.SubtotalCOP = (detalle.Cantidad * detalle.PrecioUnitarioCOP) - (detalle.Cantidad * detalle.DescuentoCOP);
    }

    private decimal CalcularSubtotal()
    {
        return model.Detalles.Sum(d => d.Cantidad * d.PrecioUnitarioCOP);
    }

    private decimal CalcularDescuentos()
    {
        return model.Detalles.Sum(d => d.Cantidad * d.DescuentoCOP);
    }

    private decimal CalcularTotal()
    {
        return CalcularSubtotal() - CalcularDescuentos();
    }

    private async Task GuardarCotizacion()
    {
        if (model.TipoCliente == "Miembro" && !model.MiembroId.HasValue)
        {
            Toast.ShowError("Debe seleccionar un miembro");
            return;
        }

        if (model.TipoCliente == "Externo" && !model.ClienteId.HasValue)
        {
            Toast.ShowError("Debe seleccionar un cliente");
            return;
        }

        if (model.Detalles.Count == 0)
        {
            Toast.ShowError("Debe agregar al menos un producto");
            return;
        }

        if (model.FechaValidez < DateTime.Now.Date)
        {
            Toast.ShowError("La fecha de validez no puede ser anterior a hoy");
            return;
        }

        guardando = true;
        try
        {
            model.SubtotalCOP = CalcularSubtotal();
            model.DescuentoCOP = CalcularDescuentos();
            model.TotalCOP = CalcularTotal();

            var response = await Http.PostAsJsonAsync("api/cotizaciones", model);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<CrearCotizacionResponse>();
                Toast.ShowSuccess("Cotización creada correctamente");
                Nav.NavigateTo($"/gerencia-negocios/cotizaciones/{result?.Id}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Toast.ShowError($"Error: {error}");
            }
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            guardando = false;
        }
    }

    private class ProductoListDto
    {
        public Guid Id { get; set; }
        public string Codigo { get; set; } = "";
        public string Nombre { get; set; } = "";
        public decimal PrecioCOP { get; set; }
        public int Stock { get; set; }
    }

    private class MiembroSimpleDto
    {
        public Guid Id { get; set; }
        public string NombreCompleto { get; set; } = "";
    }

    private class ClientesResponse
    {
        public List<ClienteDto>? Clientes { get; set; }
    }

    private class CrearCotizacionResponse
    {
        public Guid Id { get; set; }
        public string Message { get; set; } = "";
    }
}
