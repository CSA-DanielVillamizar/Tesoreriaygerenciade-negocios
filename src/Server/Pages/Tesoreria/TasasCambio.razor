@page "/tesoreria/tasas-cambio"
@attribute [Authorize(Policy = "TesoreroJuntaConsulta")]
@using Server.Data
@using Server.Models
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject MudBlazor.ISnackbar Snackbar

<PageTitle>Histórico TRM - LAMA Medellín</PageTitle>

<!-- Encabezado -->
<LamaPageHeader 
    Icon="currency_exchange" 
    Title="Histórico de TRM (USD/COP)"
    Subtitle="Tasas representativas del mercado sincronizadas desde la Superintendencia Financiera de Colombia">
</LamaPageHeader>

<!-- Alerta informativa -->
<MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true" Class="mb-4">
    <MudText Typo="Typo.body2">
        <strong>Fuente Oficial:</strong> Los valores se obtienen automáticamente cada 24 horas desde 
        <a href="https://www.datos.gov.co/resource/m974-z7cq.json" target="_blank" style="color: white; text-decoration: underline;">
            datos.gov.co
        </a> (Superintendencia Financiera). Esta es la única fuente válida para contabilidad oficial en Colombia.
    </MudText>
</MudAlert>

<!-- Estadísticas -->
<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.subtitle2" Color="Color.Primary">Última TRM</MudText>
            <MudText Typo="Typo.h5">@(_tasas.FirstOrDefault()?.UsdCop.ToString("C2") ?? "N/A")</MudText>
            <MudText Typo="Typo.caption" Class="lama-muted">
                @(_tasas.FirstOrDefault()?.Fecha.ToString("dd/MM/yyyy") ?? "")
            </MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Registros</MudText>
            <MudText Typo="Typo.h5">@_tasas.Count</MudText>
            <MudText Typo="Typo.caption" Class="lama-muted">Tasas históricas</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.subtitle2" Color="Color.Success">Automáticas</MudText>
            <MudText Typo="Typo.h5">@_tasas.Count(t => t.ObtenidaAutomaticamente)</MudText>
            <MudText Typo="Typo.caption" Class="lama-muted">Sincronizadas</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4">
            <MudText Typo="Typo.subtitle2" Color="Color.Info">Manuales</MudText>
            <MudText Typo="Typo.h5">@_tasas.Count(t => !t.ObtenidaAutomaticamente)</MudText>
            <MudText Typo="Typo.caption" Class="lama-muted">Ingresadas</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Tabla de tasas -->
<MudPaper Elevation="2" Class="pa-4">
    <MudTable Items="@_tasas" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" 
              Dense="true" FixedHeader="true" Height="600px">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Histórico de Tasas de Cambio</MudText>
            <MudSpacer />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                           Color="Color.Primary" 
                           OnClick="@CargarDatos" 
                           Title="Recargar datos" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<TasaCambio, object>(x => x.Fecha)">Fecha</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<TasaCambio, object>(x => x.UsdCop)">Valor (COP)</MudTableSortLabel></MudTh>
            <MudTh>Fuente</MudTh>
            <MudTh>Tipo</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Fecha">
                <MudText Typo="Typo.body2">@context.Fecha.ToString("dd/MM/yyyy")</MudText>
                <MudText Typo="Typo.caption" Class="lama-muted">@context.Fecha.DayOfWeek.ToString()</MudText>
            </MudTd>
            <MudTd DataLabel="Valor">
                <MudText Typo="Typo.body1" Style="font-weight: 500;">
                    @context.UsdCop.ToString("N2") COP
                </MudText>
            </MudTd>
            <MudTd DataLabel="Fuente">
                <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    @context.Fuente
                </MudText>
            </MudTd>
            <MudTd DataLabel="Tipo">
                @if (context.ObtenidaAutomaticamente)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.CloudDone">
                        Automática
                    </MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Info" Size="Size.Small" Icon="@Icons.Material.Filled.Edit">
                        Manual
                    </MudChip>
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" 
                          InfoText="Mostrando {from}-{to} de {all}" 
                          RowsPerPageString="Filas por página:" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<TasaCambio> _tasas = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        _loading = true;
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            _tasas = await db.TasasCambio
                .OrderByDescending(x => x.Fecha)
                .Take(365) // Mostrar el último año (365 días)
                .ToListAsync();
            
            if (_tasas.Count == 0)
            {
                Snackbar.Add("No hay tasas de cambio registradas en el sistema", MudBlazor.Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar tasas: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}
