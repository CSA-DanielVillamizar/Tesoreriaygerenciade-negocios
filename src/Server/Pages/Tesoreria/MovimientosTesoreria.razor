@page "/tesoreria/movimientos"
@using Server.Data
@using Server.Models
@using Server.Services.MovimientosTesoreria
@using Server.Components.Tesoreria
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Admin,Tesorero")]

@inject Server.Services.LamaToastService Toast
@inject IDialogService DialogService

<PageTitle>Movimientos de Tesorería</PageTitle>

<div class="lama-container">
  <LamaPageHeader Title="Movimientos de Tesorería"
                 Subtitle="Ledger oficial (ingresos y egresos) – audit-ready"
                 Icon="@Icons.Material.Filled.ReceiptLong">
    <Actions>
      <MudButton Variant="Variant.Filled" Color="Color.Primary"
                 StartIcon="@Icons.Material.Filled.Add"
                 OnClick="AbrirNuevoMovimiento">
        Nuevo movimiento
      </MudButton>
    </Actions>
  </LamaPageHeader>

<!-- FILTROS PREMIUM -->
  <LamaFilterCard Title="Filtros">
    <ChildContent>
      <MudItem xs="12" sm="6" md="3">
        <MudDatePicker Label="Inicio" @bind-Date="filtroInicio" />
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudDatePicker Label="Fin" @bind-Date="filtroFin" />
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudSelect Label="Cuenta" @bind-Value="filtroCuenta" Clearable="true">
          @foreach (var c in cuentas)
          {
            <MudSelectItem Value="c.Id">@c.Nombre</MudSelectItem>
          }
        </MudSelect>
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudSelect Label="Tipo" @bind-Value="filtroTipo" Clearable="true">
          <MudSelectItem Value="TipoMovimientoTesoreria.Ingreso">Ingreso</MudSelectItem>
          <MudSelectItem Value="TipoMovimientoTesoreria.Egreso">Egreso</MudSelectItem>
        </MudSelect>
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudSelect Label="Estado" @bind-Value="filtroEstado" Clearable="true">
          <MudSelectItem Value="EstadoMovimientoTesoreria.Borrador">Borrador</MudSelectItem>
          <MudSelectItem Value="EstadoMovimientoTesoreria.Aprobado">Aprobado</MudSelectItem>
          <MudSelectItem Value="EstadoMovimientoTesoreria.Anulado">Anulado</MudSelectItem>
        </MudSelect>
      </MudItem>
    </ChildContent>
    <Actions>
      <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                 StartIcon="@Icons.Material.Filled.FilterAlt"
                 OnClick="CargarMovimientos">
        Filtrar
      </MudButton>
      <MudButton Variant="Variant.Outlined" Color="Color.Default"
                 StartIcon="@Icons.Material.Filled.Refresh"
                 OnClick="LimpiarFiltros">
        Limpiar
      </MudButton>
    </Actions>
  </LamaFilterCard>

<!-- TABLA PREMIUM CON MUDTABLE -->
  @if (movimientos.Count == 0)
  {
    <LamaEmptyState Title="Sin movimientos"
            Description="No hay movimientos que coincidan con los filtros seleccionados"
            Icon="@Icons.Material.Outlined.Inbox">
      <Action>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   OnClick="AbrirNuevoMovimiento">
          Crear primer movimiento
        </MudButton>
      </Action>
    </LamaEmptyState>
  }
  else
  {
    <LamaTableWrapper>
      <MudTable Items="movimientos" Dense="true" Hover="true" Loading="@loading" FixedHeader="true" Height="500px">
        <HeaderContent>
          <MudTh>Número</MudTh>
          <MudTh>Fecha</MudTh>
          <MudTh>Tipo</MudTh>
          <MudTh>Cuenta</MudTh>
          <MudTh Class="lama-numeric">Valor</MudTh>
          <MudTh>Estado</MudTh>
          <MudTh>Creado</MudTh>
          <MudTh>Acciones</MudTh>
        </HeaderContent>

        <RowTemplate>
          <MudTd><b>@context.NumeroMovimiento</b></MudTd>
          <MudTd>@context.Fecha.ToString("dd/MM/yyyy")</MudTd>

          <MudTd>
            <LamaBadge Text="@(context.Tipo == TipoMovimientoTesoreria.Ingreso ? "Ingreso" : "Egreso")"
                      Variant="@(context.Tipo == TipoMovimientoTesoreria.Ingreso ? "success" : "danger")"
                      Icon="@(context.Tipo == TipoMovimientoTesoreria.Ingreso ? Icons.Material.Filled.TrendingDown : Icons.Material.Filled.TrendingUp)" />
          </MudTd>

          <MudTd>@cuentas.FirstOrDefault(x => x.Id == context.CuentaFinancieraId)?.Nombre</MudTd>

          <MudTd Class="lama-numeric">
            <span class="lama-currency lama-currency--@(context.Tipo == TipoMovimientoTesoreria.Ingreso ? "ingreso" : "egreso")">
              @FormatCurrency(context.Valor)
            </span>
          </MudTd>

          <MudTd>
            <LamaBadge Text="@context.Estado.ToString()"
                      Variant="@GetEstadoVariant(context.Estado)" />
          </MudTd>

          <MudTd>
            <div class="lama-muted">@context.CreatedBy</div>
            <div class="lama-muted">@context.CreatedAt.ToString("g")</div>
          </MudTd>

          <MudTd Class="lama-actions">
            <MudTooltip Text="Editar">
              <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                             OnClick="@(() => AbrirEditar(context.Id))" />
            </MudTooltip>

            @if (context.Estado != EstadoMovimientoTesoreria.Anulado)
            {
              <MudTooltip Text="Anular">
                <MudIconButton Icon="@Icons.Material.Filled.Block" Color="Color.Error" Size="Size.Small"
                               OnClick="@(() => AbrirAnular(context.Id))" />
              </MudTooltip>
            }

            <MudTooltip Text="Detalle">
              <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small"
                             OnClick="@(() => ToggleDetalle(context.Id))" />
            </MudTooltip>
          </MudTd>
        </RowTemplate>

        <ChildRowContent>
          @if (detalleMovimientoId == context.Id)
          {
            <MudTd ColSpan="8">
              <MudPaper Class="lama-card lama-detail-card" Elevation="0">
                <MudText Typo="Typo.body2"><b>Descripción:</b> @context.Descripcion</MudText>
                <MudText Typo="Typo.body2"><b>Medio:</b> @context.Medio</MudText>

                @if (!string.IsNullOrWhiteSpace(context.ReferenciaTransaccion))
                {
                  <MudText Typo="Typo.body2"><b>Referencia:</b> @context.ReferenciaTransaccion</MudText>
                }

                @if (context.Estado == EstadoMovimientoTesoreria.Anulado && !string.IsNullOrWhiteSpace(context.MotivoAnulacion))
                {
                  <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true">
                    <b>Motivo anulación:</b> @context.MotivoAnulacion <br />
                    <b>Anulado por:</b> @context.UsuarioAnulacion <br />
                    <b>Fecha:</b> @context.FechaAnulacion?.ToString("g")
                  </MudAlert>
                }
              </MudPaper>
            </MudTd>
          }
        </ChildRowContent>
      </MudTable>
    </LamaTableWrapper>
  }
</div>

@code {
    [Inject] AppDbContext Db { get; set; } = default!;
    [Inject] MovimientosTesoreriaService MovimientosService { get; set; } = default!;
    [Inject] IHttpContextAccessor HttpContext { get; set; } = default!;

    private List<MovimientoTesoreria> movimientos = new();
    private List<CuentaFinanciera> cuentas = new();
    private List<FuenteIngreso> fuentes = new();
    private List<CategoriaEgreso> categorias = new();

    private MovimientoTesoreria formularioMovimiento = new();
    private string motivoAnulacion = "";
    
    private Guid? detalleMovimientoId;
    private bool loading;

    // Filtros por defecto: últimos 18 meses para asegurar visibilidad de histórico 2025
    private DateTime? filtroInicio = DateTime.Today.AddMonths(-18).Date;
    private DateTime? filtroFin = DateTime.Today.Date;
    private Guid? filtroCuenta;
    private TipoMovimientoTesoreria? filtroTipo;
    private EstadoMovimientoTesoreria? filtroEstado;

    private string CurrentUser => HttpContext.HttpContext?.User?.Identity?.Name ?? "system";

    protected override async Task OnInitializedAsync()
    {
        cuentas = await Db.CuentasFinancieras.OrderBy(c => c.Nombre).ToListAsync();
        fuentes = await Db.FuentesIngreso.OrderBy(f => f.Nombre).ToListAsync();
        categorias = await Db.CategoriasEgreso.OrderBy(c => c.Nombre).ToListAsync();
        await CargarMovimientos();
    }

    private async Task CargarMovimientos()
    {
        try
        {
            loading = true;
            movimientos = await MovimientosService.ListAsync(
                inicio: filtroInicio,
                fin: filtroFin,
                cuentaId: filtroCuenta,
                tipo: filtroTipo,
                estado: filtroEstado,
                maxResults: 5000
            );
        }
        catch (Exception ex)
        {
            Toast.Error("Error al cargar", ex.Message);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LimpiarFiltros()
    {
        filtroInicio = DateTime.Today.AddMonths(-18).Date;
        filtroFin = DateTime.Today.Date;
        filtroCuenta = null;
        filtroTipo = null;
        filtroEstado = null;
        await CargarMovimientos();
    }

    private async Task AbrirNuevoMovimiento()
    {
      var parameters = new DialogParameters
      {
        ["Modo"] = "create",
        ["Movimiento"] = new MovimientoTesoreria
            {
                NumeroMovimiento = $"MV-{DateTime.UtcNow:yyyy}-{Guid.NewGuid().ToString()[..6].ToUpper()}",
                Fecha = DateTime.UtcNow,
                Tipo = TipoMovimientoTesoreria.Ingreso,
                Medio = MedioPagoTesoreria.Transferencia,
                CuentaFinancieraId = Guid.Empty
        },
        ["Cuentas"] = cuentas,
        ["Fuentes"] = fuentes,
        ["Categorias"] = categorias
        };

      var dialogRef = DialogService.Show<MovimientoTesoreriaFormDialog>("Nuevo Movimiento", parameters);
      var dialogResult = await dialogRef.Result;

      if (!dialogResult.Canceled)
        {
            try
            {
                loading = true;
          var movimiento = dialogResult.Data as MovimientoTesoreria;
                await MovimientosService.CreateAsync(movimiento, CurrentUser);
                Toast.Success("Creado", $"Movimiento {movimiento.NumeroMovimiento} creado exitosamente");
                await CargarMovimientos();
            }
            catch (InvalidOperationException ex)
            {
                Toast.Warning("Advertencia", ex.Message);
            }
            catch (Exception ex)
            {
                Toast.Error("Error", $"No se pudo crear: {ex.Message}");
            }
            finally
            {
                loading = false;
            }
        }
    }

    private async Task AbrirEditar(Guid id)
    {
        try
        {
            var movimiento = await MovimientosService.GetByIdAsync(id);
            if (movimiento == null)
            {
                Toast.Error("No encontrado", "El movimiento no existe");
                return;
            }

            var parameters = new DialogParameters
            {
              ["Modo"] = "edit",
              ["Movimiento"] = movimiento,
              ["Cuentas"] = cuentas,
              ["Fuentes"] = fuentes,
              ["Categorias"] = categorias
            };

            var dialogRef = DialogService.Show<MovimientoTesoreriaFormDialog>($"Editar: {movimiento.NumeroMovimiento}", parameters);
            var dialogResult = await dialogRef.Result;

            if (!dialogResult.Canceled)
            {
                loading = true;
              var movimientoActualizado = dialogResult.Data as MovimientoTesoreria;
                await MovimientosService.UpdateAsync(id, movimientoActualizado, CurrentUser);
                Toast.Success("Actualizado", $"Movimiento {movimientoActualizado.NumeroMovimiento} actualizado correctamente");
                await CargarMovimientos();
                loading = false;
            }
        }
        catch (Exception ex)
        {
            Toast.Error("Error", $"No se pudo editar: {ex.Message}");
        }
    }

    private async Task AbrirAnular(Guid id)
    {
        try
        {
            var movimiento = await MovimientosService.GetByIdAsync(id);
            if (movimiento == null)
            {
                Toast.Error("No encontrado", "El movimiento no existe");
                return;
            }

            var parameters = new DialogParameters
            {
              ["Movimiento"] = movimiento
            };

            var dialogRef = DialogService.Show<MovimientoTesoreriaAnularDialog>($"Anular: {movimiento.NumeroMovimiento}", parameters);
            var dialogResult = await dialogRef.Result;

            if (!dialogResult.Canceled)
            {
                loading = true;
              var motivo = dialogResult.Data as string;
                await MovimientosService.AnularAsync(id, motivo, CurrentUser);
                Toast.Success("Anulado", $"Movimiento {movimiento.NumeroMovimiento} anulado correctamente");
                await CargarMovimientos();
                loading = false;
            }
        }
        catch (Exception ex)
        {
            Toast.Error("Error", $"No se pudo anular: {ex.Message}");
        }
    }

    private void ToggleDetalle(Guid id)
    {
        detalleMovimientoId = detalleMovimientoId == id ? null : id;
    }

    private string GetEstadoVariant(EstadoMovimientoTesoreria estado) => estado switch
    {
        EstadoMovimientoTesoreria.Aprobado => "success",
        EstadoMovimientoTesoreria.Anulado => "danger",
        EstadoMovimientoTesoreria.Borrador => "neutral",
        _ => "primary"
    };

    private string FormatCurrency(decimal amount) => $"${amount:N0}";
}
