@page "/tesoreria/cierre"
@attribute [Authorize(Policy = "AdminOrTesoreroWith2FA")]
@using Server.Models
@using Server.Services.CierreContable
@using Server.Components.Tesoreria
@using MudBlazor
@inject CierreContableService CierreService
@inject AuthenticationStateProvider AuthStateProvider
@inject IDialogService DialogService
@inject Server.Services.LamaToastService Toast

<PageTitle>Cierre Contable Mensual - LAMA Medellín</PageTitle>

<!-- Encabezado con título y acciones -->
<LamaPageHeader 
    Icon="lock_clock" 
    Title="Cierre Contable"
    Subtitle="Cierre períodos para bloquear ediciones en recibos y egresos">
    <Actions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                   @onclick="AbrirModalCierre" Disabled="@cerrando"
                   StartIcon="@Icons.Material.Filled.Lock">
            @if (cerrando) { <span>Cerrando...</span> } else { <span>Cerrar Mes</span> }
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                   @onclick="RefrescarCierres"
                   StartIcon="@Icons.Material.Filled.Refresh">
            Refrescar
        </MudButton>
    </Actions>
</LamaPageHeader>

<!-- Filtros de período -->
<LamaFilterCard>
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudNumericField @bind-Value="anoSeleccionado" Label="Año" 
                           Min="2020" Max="2099" Variant="Variant.Outlined"
                           FullWidth />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect @bind-Value="mesSeleccionado" Label="Mes" Variant="Variant.Outlined" FullWidth>
                <MudSelectItem Value="1">Enero</MudSelectItem>
                <MudSelectItem Value="2">Febrero</MudSelectItem>
                <MudSelectItem Value="3">Marzo</MudSelectItem>
                <MudSelectItem Value="4">Abril</MudSelectItem>
                <MudSelectItem Value="5">Mayo</MudSelectItem>
                <MudSelectItem Value="6">Junio</MudSelectItem>
                <MudSelectItem Value="7">Julio</MudSelectItem>
                <MudSelectItem Value="8">Agosto</MudSelectItem>
                <MudSelectItem Value="9">Septiembre</MudSelectItem>
                <MudSelectItem Value="10">Octubre</MudSelectItem>
                <MudSelectItem Value="11">Noviembre</MudSelectItem>
                <MudSelectItem Value="12">Diciembre</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="observaciones" Label="Observaciones (opcional)" 
                         Variant="Variant.Outlined" FullWidth
                         Placeholder="Notas sobre el cierre del período..." />
        </MudItem>
    </MudGrid>
</LamaFilterCard>

<!-- Histórico de cierres -->
<div style="margin-top: 2rem;">
    @if (cargando)
    {
        <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
            @for (int i = 0; i < 3; i++)
            {
                <MudSkeleton SkeletonType="SkeletonType.Text" Height="40px" />
            }
        </div>
    }
    else if (cierres == null || !cierres.Any())
    {
        <LamaEmptyState 
            Icon="event_note"
            Title="Sin cierres registrados"
            Description="No hay períodos cerrados aún. Selecciona un período y haz clic en 'Cerrar Mes' para registrar el primer cierre." />
    }
    else
    {
        <LamaTableWrapper>
            <MudTable Items="@cierres" Striped="true" Hover="true" FixedHeader="true" Height="500px" Dense="true">
                <ColGroup>
                    <col style="width: 120px;" />
                    <col style="width: 150px;" />
                    <col style="width: 130px;" />
                    <col style="width: 130px;" />
                    <col style="width: 130px;" />
                    <col style="width: 130px;" />
                    <col style="width: 130px;" />
                    <col style="width: 200px;" />
                </ColGroup>
                <HeaderContent>
                    <MudTh>Período</MudTh>
                    <MudTh>Fecha Cierre</MudTh>
                    <MudTh>Usuario</MudTh>
                    <MudTh Style="text-align: right;">Saldo Inicial</MudTh>
                    <MudTh Style="text-align: right;">Ingresos</MudTh>
                    <MudTh Style="text-align: right;">Egresos</MudTh>
                    <MudTh Style="text-align: right;">Saldo Final</MudTh>
                    <MudTh>Observaciones</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Período">
                        <MudText Typo="Typo.body2">@ObtenerNombreMes(context.Mes) @context.Ano</MudText>
                    </MudTd>
                    <MudTd DataLabel="Fecha Cierre">
                        <MudText Typo="Typo.body2">@context.FechaCierre.ToString("dd/MM/yyyy HH:mm")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Usuario">
                        <MudText Typo="Typo.body2">@context.UsuarioCierre</MudText>
                    </MudTd>
                    <MudTd DataLabel="Saldo Inicial" Style="text-align: right;">
                        <MudText Typo="Typo.body2" Class="lama-numeric">@FormatCurrency(context.SaldoInicialCalculado)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Ingresos" Style="text-align: right;">
                        <MudText Typo="Typo.body2" Class="lama-numeric" Color="Color.Success">@FormatCurrency(context.TotalIngresos)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Egresos" Style="text-align: right;">
                        <MudText Typo="Typo.body2" Class="lama-numeric" Color="Color.Error">@FormatCurrency(context.TotalEgresos)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Saldo Final" Style="text-align: right;">
                        <MudText Typo="Typo.body2" Class="lama-numeric" 
                               Color="@(context.SaldoFinal >= 0 ? Color.Success : Color.Error)">
                            @FormatCurrency(context.SaldoFinal)
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Observaciones">
                        @if (!string.IsNullOrEmpty(context.Observaciones))
                        {
                            <MudText Typo="Typo.body2" Class="lama-muted">@context.Observaciones</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Class="lama-muted">-</MudText>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </LamaTableWrapper>
    }
</div>

@code {
    private List<CierreMensual>? cierres;
    private bool cargando = true;
    private bool cerrando = false;

    private int anoSeleccionado = DateTime.Now.Year;
    private int mesSeleccionado = DateTime.Now.Month;
    private string observaciones = "";

    protected override async Task OnInitializedAsync()
    {
        await CargarCierres();
    }

    /// <summary>
    /// Carga la lista de cierres contables registrados.
    /// </summary>
    private async Task CargarCierres()
    {
        cargando = true;
        try
        {
            cierres = await CierreService.ObtenerCierresAsync();
        }
        catch (Exception ex)
        {
            Toast.Error("Error al cargar cierres", ex.Message);
        }
        finally
        {
            cargando = false;
        }
    }

    /// <summary>
    /// Abre un diálogo MudDialog para confirmar el cierre del período.
    /// </summary>
    private async Task AbrirModalCierre()
    {
        var parameters = new DialogParameters
        {
            ["Año"] = anoSeleccionado,
            ["Mes"] = mesSeleccionado,
            ["NombreMes"] = ObtenerNombreMes(mesSeleccionado)
        };

        var dialogRef = await DialogService.ShowAsync<CierreConfirmDialog>(
            "Confirmar Cierre Contable",
            parameters
        );

        var result = await dialogRef.Result;

        if (!result.Canceled && result.Data is bool confirmed && confirmed)
        {
            await ConfirmarCierre();
        }
    }

    /// <summary>
    /// Ejecuta el cierre contable del período seleccionado.
    /// </summary>
    private async Task ConfirmarCierre()
    {
        cerrando = true;
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var usuario = authState.User.Identity?.Name ?? "Sistema";

            var cierre = await CierreService.CerrarMesAsync(
                anoSeleccionado,
                mesSeleccionado,
                usuario,
                string.IsNullOrWhiteSpace(observaciones) ? null : observaciones
            );

            Toast.Success(
                "Período cerrado",
                $"{ObtenerNombreMes(mesSeleccionado)} {anoSeleccionado} ha sido cerrado exitosamente."
            );

            observaciones = "";
            await CargarCierres();
        }
        catch (InvalidOperationException ex)
        {
            Toast.Error("No se puede cerrar el período", ex.Message);
        }
        catch (Exception ex)
        {
            Toast.Error("Error al cerrar período", ex.Message);
        }
        finally
        {
            cerrando = false;
        }
    }

    /// <summary>
    /// Recarga la lista de cierres desde el servicio.
    /// </summary>
    private async Task RefrescarCierres()
    {
        await CargarCierres();
        Toast.Info("Actualizado", "Lista de cierres refrescada.");
    }

    /// <summary>
    /// Obtiene el nombre completo del mes según su número.
    /// </summary>
    private string ObtenerNombreMes(int mes) => mes switch
    {
        1 => "Enero",
        2 => "Febrero",
        3 => "Marzo",
        4 => "Abril",
        5 => "Mayo",
        6 => "Junio",
        7 => "Julio",
        8 => "Agosto",
        9 => "Septiembre",
        10 => "Octubre",
        11 => "Noviembre",
        12 => "Diciembre",
        _ => mes.ToString()
    };

    /// <summary>
    /// Formatea un valor decimal como moneda con formato local.
    /// </summary>
    private string FormatCurrency(decimal amount) => $"${amount:N0}";
}
