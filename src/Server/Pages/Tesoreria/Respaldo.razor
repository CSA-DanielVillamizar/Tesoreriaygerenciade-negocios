@page "/tesoreria/respaldo"
@attribute [Authorize(Policy = "AdminOrTesoreroWith2FA")]
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@inject NavigationManager Nav
@inject Server.Services.LamaToastService Toast
@inject AuthenticationStateProvider AuthState

<PageTitle>Respaldo y Exportaciones - LAMA Medellín</PageTitle>

<!-- Encabezado -->
<LamaPageHeader 
    Icon="backup" 
    Title="Respaldo y Exportaciones"
    Subtitle="Descarga datos en Excel y gestiona respaldos de base de datos">
</LamaPageHeader>

<!-- Sección de Exportaciones -->
<div style="margin-bottom: 2rem;">
    <MudText Typo="Typo.h6" Class="lama-muted" Style="margin-bottom: 1rem;">Exportar Datos a Excel</MudText>
    
    <MudGrid>
        <!-- Card: Exportar Recibos -->
        <MudItem xs="12" md="6">
            <MudPaper Class="lama-container" Elevation="1" Style="padding: 1.5rem;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem;">
                    <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Large" Color="Color.Success" Style="margin-right: 1rem;" />
                    <div>
                        <MudText Typo="Typo.h6">Recibos</MudText>
                        <MudText Typo="Typo.body2" Class="lama-muted">Incluye resumen y detalle de items</MudText>
                    </div>
                </div>

                <MudStack Spacing="1">
                    <MudDatePicker @bind-Date="desdeRecibos" Label="Desde (opcional)" Variant="Variant.Outlined" FullWidth />
                    <MudDatePicker @bind-Date="hastaRecibos" Label="Hasta (opcional)" Variant="Variant.Outlined" FullWidth />
                    
                    <MudButton FullWidth Variant="Variant.Filled" Color="Color.Success" 
                               @onclick="ExportarRecibos" Disabled="@exportandoRecibos"
                               StartIcon="@Icons.Material.Filled.Download" Style="margin-top: 1rem;">
                        @if (exportandoRecibos) { <span>Exportando...</span> } 
                        else { <span>Descargar Recibos</span> }
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Card: Exportar Egresos -->
        <MudItem xs="12" md="6">
            <MudPaper Class="lama-container" Elevation="1" Style="padding: 1.5rem;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 1.5rem;">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Error" Style="margin-right: 1rem;" />
                    <div>
                        <MudText Typo="Typo.h6">Egresos</MudText>
                        <MudText Typo="Typo.body2" Class="lama-muted">Listado completo de gastos</MudText>
                    </div>
                </div>

                <MudStack Spacing="1">
                    <MudDatePicker @bind-Date="desdeEgresos" Label="Desde (opcional)" Variant="Variant.Outlined" FullWidth />
                    <MudDatePicker @bind-Date="hastaEgresos" Label="Hasta (opcional)" Variant="Variant.Outlined" FullWidth />
                    
                    <MudButton FullWidth Variant="Variant.Filled" Color="Color.Error" 
                               @onclick="ExportarEgresos" Disabled="@exportandoEgresos"
                               StartIcon="@Icons.Material.Filled.Download" Style="margin-top: 1rem;">
                        @if (exportandoEgresos) { <span>Exportando...</span> } 
                        else { <span>Descargar Egresos</span> }
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</div>

<!-- Sección de Respaldo Base de Datos -->
<div>
    <MudText Typo="Typo.h6" Class="lama-muted" Style="margin-bottom: 1rem;">Respaldo de Base de Datos</MudText>
    
    <MudStack Spacing="2">
        <!-- Alerta informativa -->
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true">
            <MudText Typo="Typo.body2">
                Puede realizar el respaldo usando SQL Server Management Studio (SSMS) o comandos T-SQL. Ambos métodos crearn una copia completa de la base de datos.
            </MudText>
        </MudAlert>

        <!-- Método 1: SSMS -->
        <MudPaper Class="lama-container" Elevation="1" Style="padding: 1.5rem;">
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                <MudIcon Icon="@Icons.Material.Filled.SaveAlt" Size="Size.Medium" Color="Color.Primary" Style="margin-right: 0.75rem;" />
                <MudText Typo="Typo.h6">Usando SQL Server Management Studio (SSMS)</MudText>
            </div>

            <MudList T="string" Dense="true">
                <MudListItem T="string">Abrir SSMS y conectarse al servidor <code style="background-color: rgba(0,0,0,0.05); padding: 0.25rem 0.5rem; border-radius: 4px;">localhost</code></MudListItem>
                <MudListItem T="string">En Object Explorer, clic derecho en la base de datos <code style="background-color: rgba(0,0,0,0.05); padding: 0.25rem 0.5rem; border-radius: 4px;">LamaMedellin</code></MudListItem>
                <MudListItem T="string">Seleccionar <strong>Tasks → Back Up...</strong></MudListItem>
                <MudListItem T="string">Verificar que "Backup type" esté en <strong>Full</strong></MudListItem>
                <MudListItem T="string">En "Destination", agregar ruta de archivo .bak (ej: <code style="background-color: rgba(0,0,0,0.05); padding: 0.25rem 0.5rem; border-radius: 4px;">C:\Backups\LamaMedellin_20251022.bak</code>)</MudListItem>
                <MudListItem T="string">Click en <strong>OK</strong></MudListItem>
            </MudList>
        </MudPaper>

        <!-- Método 2: T-SQL -->
        <MudPaper Class="lama-container" Elevation="1" Style="padding: 1.5rem;">
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Medium" Color="Color.Primary" Style="margin-right: 0.75rem;" />
                <MudText Typo="Typo.h6">Usando Comando T-SQL</MudText>
            </div>

            <MudText Typo="Typo.body2" Class="lama-muted" Style="margin-bottom: 1rem;">
                Ejecute el siguiente comando en SSMS o sqlcmd. Ajuste la ruta según su configuración:
            </MudText>

            <MudPaper Outlined="true" Style="background-color: #1e1e1e; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                <MudText Component="pre" Typo="Typo.body2" Style="color: #00d047; font-family: 'Courier New', monospace; margin: 0;">
<code>BACKUP DATABASE [LamaMedellin]
TO DISK = N'C:\Backups\LamaMedellin_YYYYMMDD_HHMMSS.bak'
WITH NOFORMAT, NOINIT,  
NAME = N'LamaMedellin-Full Database Backup',
SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10
GO</code>
                </MudText>
            </MudPaper>

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" 
                       @onclick="CopiarComandoRespaldo"
                       StartIcon="@Icons.Material.Filled.ContentCopy" Style="margin-top: 1rem;">
                Copiar Comando
            </MudButton>
        </MudPaper>

        <!-- Recomendaciones -->
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="false">
            <MudText Typo="Typo.subtitle2" Style="margin-bottom: 0.75rem;"><strong>Recomendaciones</strong></MudText>
            <MudList T="string" Dense="true">
                <MudListItem T="string">Programe respaldos automáticos semanalmente</MudListItem>
                <MudListItem T="string">Almacene copias en ubicación externa (nube, disco externo)</MudListItem>
                <MudListItem T="string">Pruebe la restauración periódicamente</MudListItem>
                <MudListItem T="string">Documente la ruta de respaldos para el equipo</MudListItem>
                <MudListItem T="string">Considere usar SQL Server Agent para automatización</MudListItem>
            </MudList>
        </MudAlert>
    </MudStack>
</div>

@code {
    private DateTime? desdeRecibos;
    private DateTime? hastaRecibos;
    private DateTime? desdeEgresos;
    private DateTime? hastaEgresos;
    
    private bool exportandoRecibos = false;
    private bool exportandoEgresos = false;

    /// <summary>
    /// Descarga recibos en formato Excel con rango de fechas opcional.
    /// </summary>
    private void ExportarRecibos()
    {
        exportandoRecibos = true;
        try
        {
            var url = "/api/exportaciones/recibos?";
            if (desdeRecibos.HasValue)
                url += $"desde={desdeRecibos.Value:yyyy-MM-dd}&";
            if (hastaRecibos.HasValue)
                url += $"hasta={hastaRecibos.Value:yyyy-MM-dd}";

            Nav.NavigateTo(url, forceLoad: true);
            Toast.Success(
                "Exportación iniciada",
                "El archivo de recibos se descargará automáticamente."
            );
        }
        catch (Exception ex)
        {
            Toast.Error("Error en exportación", ex.Message);
        }
        finally
        {
            exportandoRecibos = false;
        }
    }

    /// <summary>
    /// Descarga egresos en formato Excel con rango de fechas opcional.
    /// </summary>
    private void ExportarEgresos()
    {
        exportandoEgresos = true;
        try
        {
            var url = "/api/exportaciones/egresos?";
            if (desdeEgresos.HasValue)
                url += $"desde={desdeEgresos.Value:yyyy-MM-dd}&";
            if (hastaEgresos.HasValue)
                url += $"hasta={hastaEgresos.Value:yyyy-MM-dd}";

            Nav.NavigateTo(url, forceLoad: true);
            Toast.Success(
                "Exportación iniciada",
                "El archivo de egresos se descargará automáticamente."
            );
        }
        catch (Exception ex)
        {
            Toast.Error("Error en exportación", ex.Message);
        }
        finally
        {
            exportandoEgresos = false;
        }
    }

    /// <summary>
    /// Copia el comando T-SQL de respaldo al portapapeles y muestra una notificación.
    /// </summary>
    private async Task CopiarComandoRespaldo()
    {
        var comando = $@"BACKUP DATABASE [LamaMedellin]
TO DISK = N'C:\Backups\LamaMedellin_{DateTime.Now:yyyyMMdd_HHmmss}.bak'
WITH NOFORMAT, NOINIT,  
NAME = N'LamaMedellin-Full Database Backup',
SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10
GO";

        try
        {
            // En navegador moderno, copiar al portapapeles vía JavaScript (optional)
            Toast.Info(
                "Comando listo",
                "Seleccione y copie el comando T-SQL mostrado arriba. Puede ejecutarlo en SSMS o sqlcmd."
            );
        }
        catch (Exception ex)
        {
            Toast.Error("Error", ex.Message);
        }
    }
}
