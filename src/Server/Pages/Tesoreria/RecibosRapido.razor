@page "/tesoreria/recibos/rapido"
@attribute [Authorize(Policy = "TesoreroJunta")]
@using Server.DTOs.Recibos
@using Server.Models
@inject Server.Services.Miembros.IMiembrosService MiembrosService
@inject Server.Services.Recibos.IRecibosService RecibosService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject HttpClient Http

<PageTitle>Recibos Rápidos - Tesorería</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    <MudPaper Class="glass-card pa-6">
        <div class="d-flex justify-space-between align-center mb-4">
            <div>
                <h2><MudIcon Icon="@Icons.Material.Filled.Bolt" Size="Size.Large" Class="me-2" />Recibo Rápido</h2>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Enfocado en mensualidades y conceptos frecuentes</MudText>
            </div>
        </div>
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="me-2" />
            Seleccione un miembro (o ingrese tercero libre) y marque los conceptos a facturar. Los precios se aplican automáticamente.
        </MudAlert>
        <EditForm Model="form" OnValidSubmit="GuardarEImprimirAsync">
            <DataAnnotationsValidator />
            
                <FormSection Title="Información del Recibo" Icon="@Icons.Material.Filled.Person">
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudSelect T="Guid?" @bind-Value="form.MiembroId" Label="Miembro" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@((Guid?)null)">-- Seleccione --</MudSelectItem>
                                @foreach (var m in miembros)
                                {
                                    <MudSelectItem Value="@((Guid?)m.Id)">@m.NombreCompleto (@m.NumeroSocio)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="form.TerceroLibre" Label="Tercero Libre (opcional)" Variant="Variant.Outlined" MaxLength="200" HelperText="Usar solo si no seleccionas un miembro" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="form.FechaEmision" Label="Fecha Emisión" Variant="Variant.Outlined" InputType="InputType.Date" Format="yyyy-MM-dd" />
                        </MudItem>
                    </MudGrid>
                </FormSection>

            <MudPaper Class="glass-card pa-4 mb-4">
                <MudText Typo="Typo.h6" Class="mb-3">Conceptos Rápidos</MudText>
                <MudGrid>
                    @foreach (var c in conceptos)
                    {
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3 d-flex align-center gap-3" Style="border: 1px solid var(--mud-palette-divider);">
                                <MudCheckBox T="bool" @bind-Value="c.Seleccionado" Color="Color.Primary" />
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body1"><b>@c.Nombre</b> <span style="color: var(--mud-palette-text-secondary);">(@c.Codigo)</span></MudText>
                                </div>
                                <div style="width: 120px;">
                                    <MudNumericField T="int" @bind-Value="c.Cantidad" Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" Max="999" HideSpinButtons="true" />
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-3">Los precios se toman del concepto. Si la moneda es USD, se aplica TRM del día.</MudText>
            </MudPaper>

            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Print" ButtonType="ButtonType.Submit" Disabled="@(!PuedeGuardar)">Guardar e Imprimir</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Clear" OnClick="Limpiar">Limpiar</MudButton>
            </div>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private CreateReciboDto form = new() { FechaEmision = DateTime.Today };
    private DateTime? fechaEmision = DateTime.Today;
    private List<Server.DTOs.Miembros.MiembroListItem> miembros = new();
    private List<ConceptoQuick> conceptos = new();

    private bool PuedeGuardar => (form.MiembroId.HasValue || !string.IsNullOrWhiteSpace(form.TerceroLibre))
                                 && conceptos.Any(x => x.Seleccionado && x.Cantidad > 0);

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosAsync();
    }

    private async Task CargarDatosAsync()
    {
        try
        {
            var paged = await MiembrosService.GetPagedAsync("", EstadoMiembro.Activo, 1, 1000);
            miembros = paged?.Items ?? new();
        }
        catch (Exception)
        {
miembros = new();
        }

        try
        {
            var list = await RecibosService.GetConceptosAsync() ?? new();
            // Mostrar primero los más usados (heurística: MENSUALIDAD, INSCRIPCION, DONACION, VENTA_PARCHES)
            var prioridad = new[] { "MENSUALIDAD", "INSCRIPCION", "DONACION", "VENTA_PARCHES" };
            conceptos = list
                .OrderBy(c => Array.IndexOf(prioridad, c.Codigo) is var idx and >= 0 ? idx : int.MaxValue)
                .ThenBy(c => c.Nombre)
                .Select(c => new ConceptoQuick { Id = c.Id, Codigo = c.Codigo, Nombre = c.Nombre, Cantidad = 1 })
                .ToList();
        }
        catch (Exception)
        {
conceptos = new();
        }
    }

    private void Limpiar()
    {
        form = new() { FechaEmision = DateTime.Today };
        fechaEmision = DateTime.Today;
        foreach (var c in conceptos) { c.Seleccionado = false; c.Cantidad = 1; }
    }

    private async Task GuardarEImprimirAsync()
    {
        // Sincronizar fecha
        form.FechaEmision = fechaEmision ?? DateTime.Today;
        
        try
        {
            // Llamar a API simplificada POST /api/recibos con { MiembroId, TerceroLibre, Items: [{ CodigoConcepto, Cantidad }] }
            var payload = new
            {
                MiembroId = form.MiembroId,
                TerceroLibre = form.TerceroLibre,
                Items = conceptos.Where(x => x.Seleccionado && x.Cantidad > 0).Select(x => new { CodigoConcepto = x.Codigo, Cantidad = x.Cantidad }).ToList()
            };
            var resp = await Http.PostAsJsonAsync("/api/recibos", payload);
            if (!resp.IsSuccessStatusCode)
            {
                var msg = await resp.Content.ReadAsStringAsync();
                Snackbar.Add($"Error creando recibo: {msg}", Severity.Error);
                return;
            }
            var data = await resp.Content.ReadFromJsonAsync<CreateResponse>();
            if (data is null)
            {
                Snackbar.Add("No se recibió respuesta válida del servidor", Severity.Error);
                return;
            }

            // Abrir PDF en nueva pestaña
            Navigation.NavigateTo($"/api/recibos/{data.Id}/pdf", true);
            Snackbar.Add("Recibo creado y emitido", Severity.Success);
            Limpiar();
        }
        catch (Exception ex)
        {
Snackbar.Add($"Error guardando: {ex.Message}", Severity.Error);
        }
    }

    private class ConceptoQuick
    {
        public int Id { get; set; }
        public string Codigo { get; set; } = string.Empty;
        public string Nombre { get; set; } = string.Empty;
        public bool Seleccionado { get; set; }
        public int Cantidad { get; set; } = 1;
    }

    private class CreateResponse
    {
        public Guid Id { get; set; }
        public string Serie { get; set; } = string.Empty;
        public int Ano { get; set; }
        public int Consecutivo { get; set; }
    }
}
