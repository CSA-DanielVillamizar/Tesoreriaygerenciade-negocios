@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using Server.DTOs.ConciliacionBancaria
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<MudDialog MaxWidth="MaxWidth.Large" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.UploadFile" Class="mr-3" />
            Importar Extracto Bancario CSV - Bancolombia
        </MudText>
    </TitleContent>

    <DialogContent>
        @* ESTADO: Cargando *@
        @if (cargando)
        {
            <div class="d-flex flex-column align-center py-8">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.body1" Class="mt-4">Procesando archivo CSV...</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                    Detectando formato, validando datos y eliminando duplicados
                </MudText>
            </div>
        }
        @* ESTADO: Importación Exitosa *@
        else if (importacionExitosa)
        {
            <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mb-4">
                <MudText Typo="Typo.body1">
                    <strong>Importación completada exitosamente</strong>
                </MudText>
                <MudText Typo="Typo.body2" Class="mt-2">
                    Se procesaron <strong>@itemsImportados movimientos</strong> del archivo <strong>@nombreArchivoImportado</strong>
                </MudText>
            </MudAlert>

            @if (itemsImportados == 0)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    No se importaron movimientos nuevos. Todos los registros del archivo ya existían en el sistema (deduplicación activa).
                </MudAlert>
            }

            <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border: 1px solid var(--mud-palette-divider);">
                <MudText Typo="Typo.subtitle2" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Small" Class="mr-2" />
                    Resumen de Importación
                </MudText>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Medium" Class="mr-2" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Movimientos Importados</MudText>
                                <MudText Typo="Typo.h6">@itemsImportados</MudText>
                            </div>
                        </div>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Info" Size="Size.Medium" Class="mr-2" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Formato Detectado</MudText>
                                <MudText Typo="Typo.body1">@formatoDetectado</MudText>
                            </div>
                        </div>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            @if (itemsImportados > 0)
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4">
                    <MudText Typo="Typo.body2">
                        <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Size="Size.Small" Class="mr-2" />
                        <strong>Siguiente paso:</strong> Ejecuta el <strong>Matching Automático</strong> para conciliar estos movimientos con tus registros contables.
                    </MudText>
                </MudAlert>
            }
        }
        @* ESTADO: Error *@
        else if (!string.IsNullOrEmpty(mensajeError))
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
                <MudText Typo="Typo.body1"><strong>Error al procesar el archivo</strong></MudText>
                <MudText Typo="Typo.body2" Class="mt-2">@mensajeError</MudText>
            </MudAlert>

            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                <MudText Typo="Typo.caption"><strong>Validaciones requeridas:</strong></MudText>
                <ul class="mt-2 mb-0">
                    <li>Archivo debe ser formato CSV (.csv)</li>
                    <li>Tamaño máximo: 5 MB</li>
                    <li>Formatos soportados: Bancolombia Extracto (E*.CSV) o Movimientos (CSV_*.csv)</li>
                </ul>
            </MudAlert>
        }
        @* ESTADO: Selección de Archivo *@
        else
        {
            <MudText Typo="Typo.body2" Class="mb-4">
                Selecciona un archivo CSV de extracto bancario de <strong>Bancolombia</strong>. 
                El sistema detectará automáticamente el formato y procesará los movimientos.
            </MudText>

            @* Botón de selección de archivo *@
            <div class="d-flex justify-center mb-6">
                <label for="csvFileInput">
                    <MudButton Component="label"
                              HtmlTag="span"
                              Variant="Variant.Filled"
                              Color="Color.Primary"
                              Size="Size.Large"
                              StartIcon="@Icons.Material.Filled.CloudUpload"
                              for="csvFileInput">
                        Seleccionar Archivo CSV
                    </MudButton>
                </label>
                <InputFile OnChange="OnFileSelected" accept=".csv" id="csvFileInput" style="display:none;" />
            </div>

            @* Información del archivo seleccionado *@
            @if (archivoSeleccionado != null)
            {
                <MudPaper Elevation="2" Class="pa-4 mb-4">
                    <MudText Typo="Typo.subtitle2" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" Class="mr-2" />
                        Archivo Seleccionado
                    </MudText>
                    <MudGrid>
                        <MudItem xs="12" sm="8">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" Size="Size.Large" Class="mr-3" />
                                <div>
                                    <MudText Typo="Typo.body1"><strong>@archivoSeleccionado.Name</strong></MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Formato CSV</MudText>
                                </div>
                            </div>
                        </MudItem>
                        <MudItem xs="12" sm="4" Class="d-flex align-center justify-end">
                            <MudChip T="string" Icon="@Icons.Material.Filled.Storage" Color="Color.Info" Size="Size.Small">
                                @FormatearTamano(archivoSeleccionado.Size)
                            </MudChip>
                        </MudItem>
                    </MudGrid>

                    @* Validaciones visuales *@
                    @if (archivoSeleccionado.Size > MaxFileSizeBytes)
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-3" Dense="true">
                            El archivo excede el tamaño máximo permitido de @MaxFileSizeMB MB
                        </MudAlert>
                    }
                    else if (!archivoSeleccionado.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-3" Dense="true">
                            Solo se permiten archivos con extensión .csv
                        </MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Success" Class="mt-3" Dense="true" Variant="Variant.Outlined">
                            Archivo válido. Listo para importar.
                        </MudAlert>
                    }
                </MudPaper>

                @* Vista previa (placeholder - se puede implementar lectura previa opcional) *@
                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-divider);">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                        Información
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Al hacer clic en <strong>Importar</strong>, el sistema procesará el archivo y eliminará automáticamente 
                        los movimientos duplicados. Solo se importarán registros nuevos.
                    </MudText>
                </MudPaper>
            }
            else
            {
                @* Placeholder cuando no hay archivo *@
                <MudPaper Elevation="0" Class="pa-6 text-center" Style="border: 2px dashed var(--mud-palette-divider);">
                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-3">
                        No se ha seleccionado ningún archivo
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Formatos: Bancolombia Extracto (E*.CSV) | Movimientos (CSV_*.csv)
                    </MudText>
                </MudPaper>
            }

            @* Información adicional *@
            <MudExpansionPanels Class="mt-4" Elevation="0">
                <MudExpansionPanel Text="Formatos Soportados" Dense="true">
                    <MudList T="string" Dense="true">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                            <MudText Typo="Typo.body2"><strong>Extracto Bancolombia:</strong> E*.CSV (9 columnas, separador ;)</MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.CheckCircle" IconColor="Color.Success">
                            <MudText Typo="Typo.body2"><strong>Movimientos Bancolombia:</strong> CSV_*.csv (8 columnas, separador ,)</MudText>
                        </MudListItem>
                    </MudList>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="CancelarImportacion" Color="Color.Default">
            @(importacionExitosa ? "Cerrar" : "Cancelar")
        </MudButton>
        @if (!importacionExitosa && !cargando && archivoSeleccionado != null && EsArchivoValido())
        {
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Upload"
                      OnClick="ImportarCsv">
                Importar Movimientos
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    /// <summary>
    /// Cliente HTTP autenticado con cookie forwarding para llamadas internas.
    /// </summary>
    private HttpClient Http = default!;

    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid ConciliacionId { get; set; }

    [Parameter]
    public EventCallback<int> OnImportacionExitosa { get; set; }

    private IBrowserFile? archivoSeleccionado;
    private bool cargando = false;
    private bool importacionExitosa = false;
    private string mensajeError = string.Empty;
    private int itemsImportados = 0;
    private string formatoDetectado = string.Empty;
    private string nombreArchivoImportado = string.Empty;

    // Constantes de validación
    private const long MaxFileSizeBytes = 5 * 1024 * 1024; // 5MB
    private const int MaxFileSizeMB = 5;

    protected override Task OnInitializedAsync()
    {
        Http = HttpClientFactory.CreateClient("AuthenticatedClient");
        if (Http.BaseAddress?.AbsoluteUri is null ||
            Http.BaseAddress.AbsoluteUri == "http://localhost/" ||
            Http.BaseAddress.AbsoluteUri == "http://localhost:5000/")
        {
            Http.BaseAddress = new Uri(Navigation.BaseUri);
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// Maneja la selección del archivo CSV
    /// </summary>
    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        archivoSeleccionado = e.File;
        mensajeError = string.Empty;
        importacionExitosa = false;
        StateHasChanged();
    }

    /// <summary>
    /// Valida si el archivo cumple con los requisitos
    /// </summary>
    private bool EsArchivoValido()
    {
        if (archivoSeleccionado == null) return false;
        
        // Validación extensión
        if (!archivoSeleccionado.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            return false;
        
        // Validación tamaño
        if (archivoSeleccionado.Size > MaxFileSizeBytes)
            return false;
        
        return true;
    }

    /// <summary>
    /// Formatea el tamaño del archivo para mostrar
    /// </summary>
    private string FormatearTamano(long bytes)
    {
        if (bytes < 1024) return $"{bytes} bytes";
        if (bytes < 1024 * 1024) return $"{Math.Round(bytes / 1024.0, 2)} KB";
        return $"{Math.Round(bytes / (1024.0 * 1024.0), 2)} MB";
    }

    /// <summary>
    /// Ejecuta la importación del archivo CSV
    /// </summary>
    private async Task ImportarCsv()
    {
        if (archivoSeleccionado == null)
        {
            mensajeError = "Selecciona un archivo CSV válido";
            return;
        }

        if (!EsArchivoValido())
        {
            mensajeError = "El archivo no cumple con los requisitos (extensión .csv y tamaño máximo 5MB)";
            return;
        }

        cargando = true;
        mensajeError = string.Empty;
        StateHasChanged();

        try
        {
            using var content = new MultipartFormDataContent();

            // Leer archivo
            using var fileStream = archivoSeleccionado.OpenReadStream(maxAllowedSize: MaxFileSizeBytes);
            var fileContent = new StreamContent(fileStream);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("text/csv");

            // Construir FormData
            content.Add(new StringContent(ConciliacionId.ToString()), "conciliacionId");
            content.Add(fileContent, "archivo", archivoSeleccionado.Name);

            // Llamada HTTP POST multipart/form-data
            var response = await Http.PostAsync("api/conciliacionbancaria/cargar-csv", content);

            if (response.IsSuccessStatusCode)
            {
                // Parse respuesta exitosa
                var jsonResponse = await response.Content.ReadAsStringAsync();
                using var jsonDoc = System.Text.Json.JsonDocument.Parse(jsonResponse);
                var root = jsonDoc.RootElement;
                
                itemsImportados = root.GetProperty("itemsImportados").GetInt32();
                nombreArchivoImportado = root.GetProperty("nombreArchivo").GetString() ?? archivoSeleccionado.Name;
                formatoDetectado = "Bancolombia (detectado automáticamente)";
                importacionExitosa = true;

                // Callback a componente padre
                await OnImportacionExitosa.InvokeAsync(itemsImportados);
            }
            else
            {
                // Parse error del servidor
                var errorContent = await response.Content.ReadAsStringAsync();
                
                try
                {
                    using var errorDoc = System.Text.Json.JsonDocument.Parse(errorContent);
                    var errorRoot = errorDoc.RootElement;
                    
                    if (errorRoot.TryGetProperty("message", out var msgProp))
                    {
                        mensajeError = msgProp.GetString() ?? $"Error HTTP {response.StatusCode}";
                    }
                    else
                    {
                        mensajeError = $"Error al importar archivo: {response.StatusCode}";
                    }
                }
                catch
                {
                    mensajeError = $"Error al importar archivo ({response.StatusCode}): {errorContent}";
                }
            }
        }
        catch (HttpRequestException ex)
        {
            mensajeError = $"Error de comunicación: {ex.Message}";
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Cierra el diálogo
    /// </summary>
    private void CancelarImportacion()
    {
        if (importacionExitosa)
        {
            MudDialog.Close(DialogResult.Ok(itemsImportados));
        }
        else
        {
            MudDialog.Cancel();
        }
    }
}
