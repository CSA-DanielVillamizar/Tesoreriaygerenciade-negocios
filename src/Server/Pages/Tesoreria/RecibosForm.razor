@page "/tesoreria/recibos/nuevo"
@attribute [Authorize(Policy = "TesoreroJunta")]
@using Server.DTOs.Recibos
@using Server.Models
@inject Server.Services.Miembros.IMiembrosService MiembrosService
@inject Server.Services.Recibos.IRecibosService RecibosService
@inject Server.Services.Donaciones.ICertificadosDonacionService CertificadosService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Nuevo Recibo - Tesorería</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="py-4">
    <MudPaper Class="glass-card pa-6">
        <div class="d-flex justify-space-between align-center mb-4">
            <div>
                <h2><MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Class="me-2" />Nuevo Recibo</h2>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Registro de ingreso de fondos</MudText>
            </div>
        </div>
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="me-2" />
            Complete los datos del recibo y agregue los items correspondientes. Los montos se calcularán automáticamente según la moneda y TRM.
        </MudAlert>
        <EditForm Model="formData" OnValidSubmit="GuardarReciboAsync" OnInvalidSubmit="OnInvalidSubmitHandler">
            <DataAnnotationsValidator />
            
                <FormSection Title="Información del Recibo" Icon="@Icons.Material.Filled.Person">
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudSelect T="Guid?" @bind-Value="formData.MiembroId" Label="Miembro" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="@((Guid?)null)">-- Seleccione --</MudSelectItem>
                                @foreach (var m in miembros)
                                {
                                    <MudSelectItem Value="@((Guid?)m.Id)">@m.NombreCompleto (@m.NumeroSocio)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="formData.TerceroLibre" Label="Tercero Libre" Variant="Variant.Outlined" MaxLength="200" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="formData.FechaEmision" Label="Fecha Emisión" Variant="Variant.Outlined" InputType="InputType.Date" Format="yyyy-MM-dd" />
                        </MudItem>
                    </MudGrid>
                </FormSection>

            <MudPaper Class="glass-card pa-4 mb-4">
                <div class="d-flex justify-space-between align-center mb-3">
                    <MudText Typo="Typo.h6">Items del Recibo</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AgregarItem">Agregar Item</MudButton>
                </div>

                <MudTable Items="@formData.Items" Class="modern-table" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Concepto</MudTh>
                        <MudTh Style="width: 100px">Cantidad</MudTh>
                        <MudTh Style="width: 100px">Moneda</MudTh>
                        <MudTh Style="width: 150px">Precio Unit.</MudTh>
                        <MudTh Style="width: 120px">TRM</MudTh>
                        <MudTh Style="width: 150px" Class="text-end">Subtotal COP</MudTh>
                        <MudTh Style="width: 80px"></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="item">
                        <MudTd DataLabel="Concepto">
                            <MudSelect T="int" @bind-Value="item.ConceptoId" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="0">-- Seleccione --</MudSelectItem>
                                @foreach (var c in conceptos)
                                {
                                    <MudSelectItem Value="@c.Id">@c.Nombre (@c.Codigo)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudTd>
                        <MudTd DataLabel="Cantidad">
                            <MudNumericField T="int" @bind-Value="item.Cantidad" Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" Max="999" HideSpinButtons="true" />
                        </MudTd>
                        <MudTd DataLabel="Moneda">
                            <MudSelect T="Moneda" Value="item.MonedaOrigen" Variant="Variant.Outlined" Margin="Margin.Dense" ValueChanged="@(async (Moneda m) => await OnMonedaChangedAsync(item, m))" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="Moneda.COP">COP</MudSelectItem>
                                <MudSelectItem Value="Moneda.USD">USD</MudSelectItem>
                            </MudSelect>
                        </MudTd>
                        <MudTd DataLabel="Precio">
                            <MudNumericField T="decimal" @bind-Value="item.PrecioUnitarioMonedaOrigen" Variant="Variant.Outlined" Margin="Margin.Dense" Min="0.01m" Step="0.01m" HideSpinButtons="true" />
                        </MudTd>
                        <MudTd DataLabel="TRM">
                            <MudNumericField T="decimal?" @bind-Value="item.TrmAplicada" Variant="Variant.Outlined" Margin="Margin.Dense" Min="0m" Step="0.01m" Disabled="@(item.MonedaOrigen == Moneda.COP)" HideSpinButtons="true" />
                        </MudTd>
                        <MudTd DataLabel="Subtotal" Class="text-end">
                            <MudText Typo="Typo.body1"><b>$@CalcularSubtotalCop(item).ToString("N0")</b></MudText>
                        </MudTd>
                        <MudTd DataLabel="">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => QuitarItem(item))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>

                <FormSection Title="Observaciones y Total" Icon="@Icons.Material.Filled.Notes">
                    <MudGrid>
                        <MudItem xs="12" md="8">
                            <MudTextField @bind-Value="formData.Observaciones" Label="Observaciones" Variant="Variant.Outlined" Lines="3" MaxLength="500" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Class="pa-3" Style="background: linear-gradient(135deg, var(--mud-palette-primary-lighten) 0%, var(--mud-palette-primary) 100%); color: white;">
                                <MudText Typo="Typo.body2" Class="mb-1">Total COP</MudText>
                                <MudText Typo="Typo.h4"><b>$@formData.Items.Sum(i => CalcularSubtotalCop(i)).ToString("N0")</b></MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </FormSection>

            @if (!CanSave)
            {
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Warning" Class="me-2" />
                    Complete los campos de los ítems: concepto, cantidad (&gt;0), precio (&gt;0) y TRM si la moneda es USD.
                </MudAlert>
            }

            <div class="d-flex gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Save" ButtonType="ButtonType.Submit" Disabled="@(!CanSave)">Guardar Recibo</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Clear" OnClick="LimpiarForm">Limpiar</MudButton>
            </div>
        </EditForm>
    </MudPaper>
</MudContainer>


<MudDialog @bind-Visible="mostrarModalCertificado" Options="new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small }">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CardGiftcard" Class="me-2" />
            Recibo Guardado - Donación Detectada
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="me-2" />
            <b>Recibo guardado exitosamente.</b>
        </MudAlert>
        <MudText Typo="Typo.body1" Class="mb-3">
            Se detectó que este recibo contiene un concepto de <b>DONACIÓN</b>.
        </MudText>
        <MudText Typo="Typo.body1" Class="mb-3">
            ¿Desea generar un <b>Certificado de Donación (RTE)</b> para este recibo?
        </MudText>
        <MudPaper Class="pa-3 mb-3" Style="background-color: var(--mud-palette-background-grey);">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Donante:</MudText>
            <MudText Typo="Typo.body1"><b>@nombreTerceroParaCertificado</b></MudText>
        </MudPaper>
        <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true">
            <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Class="me-1" />
            <b>Tip:</b> El certificado pre-llenará los datos del donante y el valor de la donación automáticamente.
        </MudAlert>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="IrAListaRecibos">No, ir a lista de recibos</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Description" OnClick="CrearCertificadoDonacion">Sí, Crear Certificado</MudButton>
    </DialogActions>
</MudDialog>


@code {
    private CreateReciboDto formData = new() { FechaEmision = DateTime.Today };
    private List<Server.DTOs.Miembros.MiembroListItem> miembros = new();
    private List<Server.DTOs.Recibos.ConceptoListItem> conceptos = new();
    private static bool _dataLoaded = false;
    private static List<Server.DTOs.Miembros.MiembroListItem> _cachedMiembros = new();
    private static List<Server.DTOs.Recibos.ConceptoListItem> _cachedConceptos = new();
    
    // Variables para modal de certificado de donación
    private bool mostrarModalCertificado = false;
    private Guid? reciboIdParaCertificado = null;
    private string nombreTerceroParaCertificado = string.Empty;
    
    // Indica si el formulario cumple condiciones mínimas para permitir guardar.
    private bool CanSave => formData.Items.Count > 0 &&
                            formData.Items.All(i => i.ConceptoId > 0 &&
                                                     i.Cantidad > 0 &&
                                                     i.PrecioUnitarioMonedaOrigen > 0 &&
                                                     (i.MonedaOrigen != Moneda.USD || (i.TrmAplicada.HasValue && i.TrmAplicada.Value > 0)));

    protected override async Task OnInitializedAsync()
    {
        // Cargar datos solo si no están en caché
        if (!_dataLoaded)
        {
            try
            {
                var paged = await MiembrosService.GetPagedAsync("", EstadoMiembro.Activo, 1, 1000);
                _cachedMiembros = paged?.Items ?? new();
            }
            catch (Exception)
            {
_cachedMiembros = new();
            }

            try
            {
                _cachedConceptos = await RecibosService.GetConceptosAsync() ?? new();
            }
            catch (Exception)
            {
_cachedConceptos = new();
            }

            _dataLoaded = true;
        }

        // Usar datos cacheados
        miembros = _cachedMiembros;
        conceptos = _cachedConceptos;

        // Siempre asegurar que haya al menos un ítem inicial
        if (formData.Items.Count == 0)
        {
            formData.Items.Add(new CreateReciboItemDto { MonedaOrigen = Moneda.COP, Cantidad = 1, PrecioUnitarioMonedaOrigen = 0 });
}
    }

    private void AgregarItem()
    {
var newItem = new CreateReciboItemDto { MonedaOrigen = Moneda.COP, Cantidad = 1, PrecioUnitarioMonedaOrigen = 0 };
        formData.Items.Add(newItem);
// Forzar re-render inmediato
        InvokeAsync(StateHasChanged);
    }

    private void QuitarItem(CreateReciboItemDto item)
    {
        if (formData.Items.Count > 1)
        {
            formData.Items.Remove(item);
            InvokeAsync(StateHasChanged);
        }
    }

    private void LimpiarForm()
    {
        formData = new() { FechaEmision = DateTime.Today };
        AgregarItem();
    }

    private async Task OnMonedaChangedAsync(CreateReciboItemDto item, Moneda moneda)
    {
        item.MonedaOrigen = moneda;
        
        if (item.MonedaOrigen == Moneda.USD)
        {
            // Buscar TRM para la fecha
            var trm = await RecibosService.GetTrmAsync(formData.FechaEmision);
            item.TrmAplicada = trm;
}
        else
        {
            item.TrmAplicada = null;
        }
        await InvokeAsync(StateHasChanged);
    }

    private decimal CalcularSubtotalCop(CreateReciboItemDto item)
    {
        if (item.MonedaOrigen == Moneda.USD && item.TrmAplicada.HasValue)
            return item.Cantidad * item.PrecioUnitarioMonedaOrigen * item.TrmAplicada.Value;
        return item.Cantidad * item.PrecioUnitarioMonedaOrigen;
    }

    private async Task GuardarReciboAsync()
    {
        try
        {
foreach (var item in formData.Items)
            {
}
            
            var reciboId = await RecibosService.CreateAsync(formData, "tesorero");
// Verificar si algún item es de tipo DONACION
            var tieneDonacion = formData.Items.Any(item => 
            {
                var concepto = conceptos.FirstOrDefault(c => c.Id == item.ConceptoId);
                return concepto != null && concepto.Codigo.Contains("DONACION", StringComparison.OrdinalIgnoreCase);
            });

            await InvokeAsync(() =>
            {
                if (tieneDonacion)
                {
                    reciboIdParaCertificado = reciboId;
                    nombreTerceroParaCertificado = !string.IsNullOrWhiteSpace(formData.TerceroLibre) 
                        ? formData.TerceroLibre 
                        : miembros.FirstOrDefault(m => m.Id == formData.MiembroId)?.NombreCompleto ?? "";
                    mostrarModalCertificado = true;
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("Recibo guardado exitosamente", Severity.Success);
                    Navigation.NavigateTo("/tesoreria/recibos", forceLoad: true);
                }
            });
        }
        catch (Exception ex)
        {
Console.WriteLine($"Stack trace: {ex.StackTrace}");
            await InvokeAsync(() =>
            {
                Snackbar.Add($"Error al guardar recibo: {ex.Message}", Severity.Error);
            });
        }
    }

    private void OnInvalidSubmitHandler(EditContext editContext)
    {
foreach (var validation in editContext.GetValidationMessages())
        {
}
        // El ValidationSummary ya está en el formulario y mostrará los errores.
    }

    private void IrAListaRecibos()
    {
           InvokeAsync(() =>
           {
              mostrarModalCertificado = false;
              Snackbar.Add("Recibo guardado exitosamente", Severity.Success);
              Navigation.NavigateTo("/tesoreria/recibos", forceLoad: true);
           });
    }

    private void CrearCertificadoDonacion()
    {
            InvokeAsync(() =>
        {
                if (reciboIdParaCertificado.HasValue)
                {
                    mostrarModalCertificado = false;
                    Navigation.NavigateTo($"/tesoreria/donaciones/nuevo?reciboId={reciboIdParaCertificado.Value}", forceLoad: true);
                }
            });
    }

    // DTOs para autocompletar
    // Eliminadas clases locales. Se usan los DTOs importados.
}