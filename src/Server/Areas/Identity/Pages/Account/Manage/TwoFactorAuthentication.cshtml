@page
@model Server.Areas.Identity.Pages.Account.Manage.TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "Two-factor authentication";
    ViewData["ActivePage"] = "TwoFactorAuthentication";
}

<partial name="_StatusMessage" for="StatusMessage" />
<h3>@ViewData["Title"]</h3>

<div class="mt-3">
    <h4>Two-factor authentication (2FA)</h4>

    @if (Model.Is2faEnabled)
    {
        <div class="alert alert-success" role="alert">
            ✅ 2FA está habilitado para tu cuenta.
        </div>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            ⚠️ 2FA no está habilitado para tu cuenta.
        </div>
    }

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">Authenticator app</h5>
            <p class="card-text">Configura o restablece tu autenticador.</p>
            <div class="d-flex gap-2 flex-wrap">
                <a class="btn btn-primary" href="/Identity/Account/Manage/EnableAuthenticator">Configurar autenticador</a>
                <a class="btn btn-outline-danger" href="/Identity/Account/Manage/ResetAuthenticator">Restablecer autenticador</a>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <span class="text-muted">Códigos de recuperación disponibles: <strong>@Model.RecoveryCodesLeft</strong></span>
    </div>
</div>

@if (User.IsInRole("Admin"))
{
    <div class="alert alert-warning mt-4" role="alert">
        <strong>Soporte Admin:</strong> Si el banner de 2FA sigue apareciendo después de verificar el autenticador, usa las acciones de respaldo.
        <div class="mt-3 d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-danger" onclick="forceEnable2fa()">Forzar habilitación 2FA</button>
            <button type="button" class="btn btn-secondary" onclick="refreshSecurityStamp()">Refrescar Security Stamp</button>
        </div>
        <div id="admin2faResult" class="mt-3"></div>
    </div>
}

@section Scripts {
    <script type="text/javascript">
        async function forceEnable2fa() {
            const result = document.getElementById('admin2faResult');
            result.innerHTML = '<div class="text-info">⏳ Forzando 2FA...</div>';
            try {
                const response = await fetch('/api/admin/security-stamp/enable-2fa-self', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="text-success">✅ ${data.message}</div>`;
                } else {
                    const text = await response.text();
                    result.innerHTML = `<div class="text-danger">❌ Error: ${text || response.status}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="text-danger">❌ Error de conexión: ${error.message}</div>`;
            }
        }

        async function refreshSecurityStamp() {
            const result = document.getElementById('admin2faResult');
            result.innerHTML = '<div class="text-info">⏳ Refrescando Security Stamp...</div>';
            try {
                const response = await fetch('/api/admin/security-stamp/refresh-self', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="text-success">✅ ${data.message}</div>`;
                } else {
                    const text = await response.text();
                    result.innerHTML = `<div class="text-danger">❌ Error: ${text || response.status}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="text-danger">❌ Error de conexión: ${error.message}</div>`;
            }
        }
    </script>
}
